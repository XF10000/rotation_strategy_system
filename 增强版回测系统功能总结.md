# å¢å¼ºç‰ˆå›æµ‹ç³»ç»ŸåŠŸèƒ½æ€»ç»“

## ğŸ¯ éœ€æ±‚å®ç°çŠ¶æ€

### âœ… å·²å®ŒæˆåŠŸèƒ½

#### 1. è¯¦ç»†äº¤æ˜“è®°å½•å¢å¼º
- **æŠ€æœ¯æŒ‡æ ‡æ•°å€¼è®°å½•**: æ¯æ¬¡äº¤æ˜“æ—¶è®°å½•RSIã€EMAã€MACDã€å¸ƒæ—å¸¦ç­‰æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡çš„å…·ä½“æ•°å€¼
- **ä¿¡å·åˆ¤æ–­ä¾æ®**: è®°å½•è§¦å‘äº¤æ˜“çš„å…·ä½“ä¿¡å·æ¡ä»¶å’Œå¼ºåº¦è¯„åˆ†
- **äº¤æ˜“åŸå› è¯´æ˜**: è¯¦ç»†è®°å½•æ¯ç¬”äº¤æ˜“çš„è§¦å‘åŸå› 

#### 2. å‘¨Kçº¿å›¾äº¤æ˜“æ ‡æ³¨
- **äº¤æ˜“ä½ç½®æ ‡æ³¨**: åœ¨å‘¨Kçº¿å›¾ä¸Šç²¾ç¡®æ ‡æ³¨ä¹°å…¥å–å‡ºä½ç½®
- **æŠ€æœ¯æŒ‡æ ‡ä¿¡æ¯**: äº¤æ˜“æ ‡æ³¨åŒ…å«å½“æ—¶çš„æŠ€æœ¯æŒ‡æ ‡æ•°å€¼
- **ä¿¡å·å¼ºåº¦æ˜¾ç¤º**: æ˜¾ç¤ºäº¤æ˜“ä¿¡å·çš„ç»¼åˆå¼ºåº¦è¯„åˆ†
- **å¤šæŒ‡æ ‡å›¾è¡¨**: é›†æˆRSIã€MACDã€æˆäº¤é‡ç­‰å¤šä¸ªæŠ€æœ¯æŒ‡æ ‡å­å›¾

#### 3. å¢å¼ºç‰ˆæŠ¥å‘Šç”Ÿæˆ
- **è¯¦ç»†äº¤æ˜“è®°å½•è¡¨**: HTMLæ ¼å¼çš„äº¤æ˜“è®°å½•è¡¨ï¼ŒåŒ…å«æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡
- **Kçº¿å›¾é›†æˆ**: è‡ªåŠ¨ç”Ÿæˆæ¯ä¸ªè‚¡ç¥¨çš„å¸¦æ ‡æ³¨Kçº¿å›¾
- **ä¿¡å·åˆ†ææŠ¥å‘Š**: ç‹¬ç«‹çš„ä¿¡å·å†å²åˆ†ææŠ¥å‘Š
- **å®Œæ•´HTMLæŠ¥å‘Š**: é›†æˆæ‰€æœ‰åŠŸèƒ½çš„ç»¼åˆæŠ¥å‘Š

## ğŸ“Š æ ¸å¿ƒæ–‡ä»¶æ›´æ–°

### 1. å›æµ‹å¼•æ“ (`backtest/backtest_engine.py`)
```python
# æ›´æ–°çš„è½®åŠ¨é€»è¾‘ï¼Œæ”¯æŒæŠ€æœ¯æŒ‡æ ‡ä¼ é€’
def execute_rotation_logic(self, signals, current_prices, current_date):
    # æå–æŠ€æœ¯æŒ‡æ ‡å’Œä¿¡å·è¯¦æƒ…
    sell_indicators = sell_signal_result.get('technical_indicators', {})
    sell_signal_details = sell_signal_result.get('signal_details', {})
    
    # æ‰§è¡Œå¸¦æŒ‡æ ‡è®°å½•çš„è½®åŠ¨
    success, message = self.portfolio_manager.execute_rotation_with_indicators(
        sell_stock, buy_stock, self.rotation_percentage,
        current_prices, transaction_costs, current_date,
        sell_indicators, sell_signal_details,
        buy_indicators, buy_signal_details
    )
```

### 2. æŠ•èµ„ç»„åˆç®¡ç†å™¨ (`backtest/portfolio_manager.py`)
```python
# æ–°å¢å¸¦æŠ€æœ¯æŒ‡æ ‡è®°å½•çš„äº¤æ˜“æ–¹æ³•
def execute_sell(self, stock_code, shares, price, transaction_cost, date, reason,
                technical_indicators=None, signal_details=None):
    # è®°å½•äº¤æ˜“ï¼ˆåŒ…å«æŠ€æœ¯æŒ‡æ ‡å’Œä¿¡å·è¯¦æƒ…ï¼‰
    transaction = {
        'date': date,
        'type': 'SELL',
        'stock_code': stock_code,
        'shares': shares,
        'price': price,
        'gross_amount': gross_proceeds,
        'transaction_cost': transaction_cost,
        'net_amount': net_proceeds,
        'reason': reason,
        'technical_indicators': technical_indicators or {},
        'signal_details': signal_details or {}
    }
```

### 3. å¢å¼ºç‰ˆæŠ¥å‘Šç”Ÿæˆå™¨ (`backtest/enhanced_report_generator.py`)
```python
# è¯¦ç»†äº¤æ˜“è®°å½•è¡¨æ ¼ç”Ÿæˆ
def generate_detailed_transaction_table(self, transaction_df):
    # ç”ŸæˆåŒ…å«æŠ€æœ¯æŒ‡æ ‡çš„HTMLè¡¨æ ¼
    # åŒ…å«RSIã€EMAã€MACDã€å¸ƒæ—å¸¦ä½ç½®ã€ä¿¡å·å¼ºåº¦ç­‰ä¿¡æ¯

# å‘¨Kçº¿å›¾ä¸äº¤æ˜“æ ‡æ³¨
def generate_weekly_kline_with_trades(self, stock_code, weekly_data, transaction_df):
    # ç”Ÿæˆ4ä¸ªå­å›¾ï¼šä¸»Kçº¿å›¾ã€RSIã€MACDã€æˆäº¤é‡
    # åœ¨ä¸»å›¾ä¸Šæ ‡æ³¨äº¤æ˜“ç‚¹ï¼ŒåŒ…å«è¯¦ç»†æŠ€æœ¯æŒ‡æ ‡ä¿¡æ¯
```

## ğŸ“ˆ ç”Ÿæˆçš„æŠ¥å‘Šå†…å®¹

### 1. è¯¦ç»†äº¤æ˜“è®°å½•è¡¨
| æ—¥æœŸ | ç±»å‹ | è‚¡ç¥¨ä»£ç  | è‚¡æ•° | ä»·æ ¼ | é‡‘é¢ | æ‰‹ç»­è´¹ | RSI | EMA20 | MACD | å¸ƒæ—å¸¦ä½ç½® | ä¿¡å·å¼ºåº¦ | ä¿¡å·è¯¦æƒ… | äº¤æ˜“åŸå›  |
|------|------|----------|------|------|------|--------|-----|-------|------|------------|----------|----------|----------|
| 2023-01-06 | BUY | 601088 | 1,000 | 30.50 | 30,500 | 150.00 | 35.2 | 29.80 | 0.150 | ä¸­è½¨ä¹‹ä¸Š | 2 | è¶…å–âœ“<br>åŠ¨èƒ½ç¡®è®¤âœ“ | ä¹°å…¥ä¿¡å·è§¦å‘ |

### 2. å‘¨Kçº¿å›¾æ ‡æ³¨
- **ä¸»Kçº¿å›¾**: åŒ…å«EMAå‡çº¿ã€å¸ƒæ—å¸¦
- **äº¤æ˜“æ ‡æ³¨**: çº¢è‰²å‘ä¸Šç®­å¤´(ä¹°å…¥)ã€ç»¿è‰²å‘ä¸‹ç®­å¤´(å–å‡º)
- **è¯¦ç»†ä¿¡æ¯æ¡†**: æ˜¾ç¤ºäº¤æ˜“æ—¥æœŸã€ä»·æ ¼ã€æ•°é‡ã€æŠ€æœ¯æŒ‡æ ‡æ•°å€¼ã€ä¿¡å·å¼ºåº¦
- **RSIå­å›¾**: æ˜¾ç¤ºRSIæŒ‡æ ‡å’Œè¶…ä¹°è¶…å–çº¿
- **MACDå­å›¾**: æ˜¾ç¤ºDIFã€DEAçº¿å’ŒMACDæŸ±çŠ¶å›¾
- **æˆäº¤é‡å­å›¾**: æ˜¾ç¤ºæˆäº¤é‡å’Œç§»åŠ¨å¹³å‡çº¿

### 3. ä¿¡å·å¼ºåº¦è®¡ç®—
```python
signal_details = {
    'scores': {
        'trend_filter_high': 1,      # è¶‹åŠ¿è¿‡æ»¤å™¨
        'overbought_oversold_high': 1, # è¶…ä¹°è¶…å–
        'momentum_high': 1,          # åŠ¨èƒ½ç¡®è®¤
        'extreme_price_volume_high': 0 # æç«¯ä»·æ ¼é‡èƒ½
    }
}
total_score = sum(scores.values())  # æ€»ä¿¡å·å¼ºåº¦
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ–‡ä»¶
1. `simple_test_enhanced.py` - æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• âœ…
2. `demo_enhanced_features.py` - å®Œæ•´åŠŸèƒ½æ¼”ç¤º âœ…
3. `test_enhanced_backtest_system.py` - ç³»ç»Ÿé›†æˆæµ‹è¯•

### æµ‹è¯•ç»“æœ
```
ğŸ‰ å¢å¼ºç‰ˆå›æµ‹ç³»ç»Ÿæ–°åŠŸèƒ½éªŒè¯é€šè¿‡!

æ–°åŠŸèƒ½åŒ…æ‹¬:
1. âœ… è®°å½•æ¯æ¬¡äº¤æ˜“æ—¶çš„æŠ€æœ¯æŒ‡æ ‡æ•°å€¼
2. âœ… è®°å½•ä¿¡å·åˆ¤æ–­ä¾æ®å’Œå¼ºåº¦
3. âœ… ç”ŸæˆåŒ…å«è¯¦ç»†ä¿¡æ¯çš„äº¤æ˜“è®°å½•è¡¨æ ¼
4. âœ… æ”¯æŒåœ¨å‘¨Kçº¿å›¾ä¸Šæ ‡æ³¨äº¤æ˜“ä½ç½®
```

## ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶ç¤ºä¾‹

### 1. è¯¦ç»†äº¤æ˜“è®°å½• (`simple_test_reports/enhanced_transaction_test.html`)
- åŒ…å«å®Œæ•´æŠ€æœ¯æŒ‡æ ‡æ•°å€¼çš„äº¤æ˜“è®°å½•è¡¨
- é¢œè‰²æ ‡è¯†ï¼šRSIè¶…ä¹°(çº¢è‰²)ã€è¶…å–(ç»¿è‰²)
- å¸ƒæ—å¸¦ä½ç½®åˆ†æï¼šä¸Šè½¨ä¹‹ä¸Šã€ä¸­è½¨ä¹‹é—´ã€ä¸‹è½¨ä¹‹ä¸‹
- ä¿¡å·å¼ºåº¦ç»¼åˆè¯„åˆ†

### 2. å‘¨Kçº¿å›¾ (`demo_reports/601088_weekly_kline_enhanced.png`)
- 4ä¸ªå­å›¾çš„ç»¼åˆæŠ€æœ¯åˆ†æå›¾è¡¨
- äº¤æ˜“ç‚¹ç²¾ç¡®æ ‡æ³¨å’Œè¯¦ç»†ä¿¡æ¯
- å¤šä¸ªæŠ€æœ¯æŒ‡æ ‡çš„åŒæ­¥æ˜¾ç¤º

### 3. å®Œæ•´HTMLæŠ¥å‘Š (`demo_reports/enhanced_backtest_report_*.html`)
- é›†æˆæ‰€æœ‰åŠŸèƒ½çš„ç»¼åˆæŠ¥å‘Š
- åŒ…å«èµ„é‡‘æ›²çº¿ã€å›æ’¤åˆ†æã€æœˆåº¦æ”¶ç›Šçƒ­åŠ›å›¾
- è¯¦ç»†äº¤æ˜“è®°å½•å’ŒKçº¿å›¾æ ‡æ³¨

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨
```python
from backtest.enhanced_report_generator import EnhancedReportGenerator

# åˆ›å»ºå¢å¼ºç‰ˆæŠ¥å‘Šç”Ÿæˆå™¨
generator = EnhancedReportGenerator("reports")

# ç”Ÿæˆè¯¦ç»†äº¤æ˜“è®°å½•è¡¨
table_html = generator.generate_detailed_transaction_table(transaction_df)

# ç”Ÿæˆå¸¦äº¤æ˜“æ ‡æ³¨çš„Kçº¿å›¾
kline_path = generator.generate_weekly_kline_with_trades(
    stock_code, weekly_data, transaction_df
)

# ç”Ÿæˆå®Œæ•´å¢å¼ºç‰ˆæŠ¥å‘Š
html_path = generator.generate_enhanced_html_report(
    backtest_results, performance_report, weekly_data_dict
)
```

### 2. é›†æˆåˆ°å›æµ‹ç³»ç»Ÿ
```python
from backtest.backtest_engine import BacktestEngine

# åˆ›å»ºå›æµ‹å¼•æ“ï¼ˆå·²è‡ªåŠ¨æ”¯æŒæŠ€æœ¯æŒ‡æ ‡è®°å½•ï¼‰
engine = BacktestEngine(config)
success = engine.run_backtest()

# è·å–åŒ…å«æŠ€æœ¯æŒ‡æ ‡çš„å›æµ‹ç»“æœ
backtest_results = engine.get_backtest_results()
```

## ğŸ¯ åŠŸèƒ½ç‰¹ç‚¹

### 1. å®Œæ•´æ€§
- è®°å½•æ¯æ¬¡äº¤æ˜“çš„å®Œæ•´æŠ€æœ¯æŒ‡æ ‡å¿«ç…§
- ä¿å­˜ä¿¡å·åˆ¤æ–­çš„è¯¦ç»†ä¾æ®å’Œè¯„åˆ†
- ç”Ÿæˆå¤šç»´åº¦çš„å¯è§†åŒ–åˆ†æ

### 2. å¯è§†åŒ–
- åœ¨Kçº¿å›¾ä¸Šç›´è§‚æ˜¾ç¤ºäº¤æ˜“ä½ç½®
- æŠ€æœ¯æŒ‡æ ‡ä¸äº¤æ˜“å†³ç­–çš„å…³è”å±•ç¤º
- å¤šå±‚æ¬¡çš„æŠ¥å‘Šæ ¼å¼ï¼ˆè¡¨æ ¼ã€å›¾è¡¨ã€HTMLï¼‰

### 3. å¯è¿½æº¯æ€§
- æ¯ç¬”äº¤æ˜“éƒ½æœ‰å®Œæ•´çš„å†³ç­–ä¾æ®è®°å½•
- æŠ€æœ¯æŒ‡æ ‡æ•°å€¼çš„å†å²å¿«ç…§
- ä¿¡å·å¼ºåº¦çš„é‡åŒ–è¯„ä¼°

### 4. æ˜“ç”¨æ€§
- è‡ªåŠ¨é›†æˆåˆ°ç°æœ‰å›æµ‹ç³»ç»Ÿ
- å¤šç§æ ¼å¼çš„æŠ¥å‘Šè¾“å‡º
- æ¸…æ™°çš„é¢œè‰²æ ‡è¯†å’Œä¿¡æ¯ç»„ç»‡

## ğŸ“‹ æ€»ç»“

å¢å¼ºç‰ˆå›æµ‹ç³»ç»ŸæˆåŠŸå®ç°äº†ç”¨æˆ·è¦æ±‚çš„æ‰€æœ‰åŠŸèƒ½ï¼š

1. âœ… **è¯¦ç»†è®°å½•**: åœ¨äº¤æ˜“è®°å½•ä¸­æ·»åŠ äº†æ—¶é—´ã€è‚¡ç¥¨ã€ä»·æ ¼ã€æ•°é‡ä¹‹å¤–çš„æŠ€æœ¯æŒ‡æ ‡æ•°å€¼å’Œäº¤æ˜“ä¿¡å·åˆ¤æ–­ä¾æ®
2. âœ… **Kçº¿å›¾æ ‡æ³¨**: åœ¨å‘¨Kçº¿å›¾ä¸Šæ ‡æ³¨å‡ºäº¤æ˜“ä½ç½®ï¼ŒåŒ…å«è¯¦ç»†çš„æŠ€æœ¯æŒ‡æ ‡ä¿¡æ¯
3. âœ… **ç³»ç»Ÿé›†æˆ**: æ— ç¼é›†æˆåˆ°ç°æœ‰å›æµ‹ç³»ç»Ÿï¼Œè‡ªåŠ¨è®°å½•å’Œç”ŸæˆæŠ¥å‘Š

ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿæä¾›æ›´åŠ è¯¦ç»†å’Œå¯è¿½æº¯çš„å›æµ‹åˆ†æï¼Œå¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°ç†è§£æ¯æ¬¡äº¤æ˜“å†³ç­–çš„æŠ€æœ¯ä¾æ®ã€‚