<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 中线轮动策略增强版回测报告</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .section h2 {
            color: #4a5568;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .metric-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .metric-card .value {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .kline-section {
            margin-bottom: 30px;
        }
        
        .stock-selector {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stock-selector select {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            color: #333;
            cursor: pointer;
        }
        
        #klineChart {
            width: 100%;
            height: 800px;
            border-radius: 10px;
            background: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f7fafc;
        }
        
        .buy-row {
            background-color: #f0fff4;
        }
        
        .sell-row {
            background-color: #fff5f5;
        }
        
        .signal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .signal-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .signal-card h4 {
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .signal-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .final-portfolio-status {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .portfolio-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        
        .summary-label {
            font-weight: bold;
            color: #495057;
        }
        
        .summary-value {
            color: #007bff;
            font-weight: bold;
        }
        
        .stock-positions {
            margin-top: 20px;
        }
        
        .positions-table {
            width: 100%;
            margin-top: 10px;
            border-collapse: collapse;
        }
        
        .positions-table th,
        .positions-table td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #dee2e6;
        }
        
        .positions-table th {
            background: #e9ecef;
            font-weight: bold;
        }
        
        .positions-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .benchmark-comparison {
            margin: 20px 0;
        }
        
        .comparison-summary {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .comparison-summary.outperform {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
            color: #155724;
        }
        
        .comparison-summary.underperform {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 2px solid #dc3545;
            color: #721c24;
        }
        
        .comparison-table table {
            width: 100%;
            margin: 20px 0;
        }
        
        .comparison-table .outperform {
            color: #28a745;
            font-weight: bold;
        }
        
        .comparison-table .underperform {
            color: #dc3545;
            font-weight: bold;
        }
        
        .performance-analysis {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .performance-analysis ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .performance-analysis li {
            margin: 5px 0;
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
        }
        .transaction-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 4px;
            text-align: center;
            font-weight: bold;
            font-size: 11px;
        }
        .transaction-table td {
            border: 1px solid #dee2e6;
            padding: 6px 4px;
            text-align: center;
            font-size: 11px;
        }
        .signal-check { color: #28a745; font-weight: bold; }
        .signal-cross { color: #dc3545; font-weight: bold; }
        .signal-neutral { color: #6c757d; }
        .bb-position { font-size: 10px; }

        .global-summary {
            margin-bottom: 30px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card.total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .summary-card.buy {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .summary-card.sell {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .summary-card.ratio {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }
        
        .summary-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .summary-title {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .dimension-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .dim-summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .dim-name {
            font-weight: bold;
            color: #495057;
        }
        
        .dim-count {
            font-weight: bold;
            color: #007bff;
        }
        
        .dim-rate {
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 中线轮动策略增强版回测报告</h1>
            <p>生成时间: 2025-07-26 17:54:46</p>
            <p>包含技术指标详情与4维信号分析</p>
        </div>
        
        <!-- K线图与交易点分析 -->
        <div class="section kline-section">
            <h2>📊 周K线图与交易点分析</h2>
            <div class="stock-selector">
                <label for="stockSelect">选择股票: </label>
                <select id="stockSelect" onchange="updateKlineChart()">
                    <option value="">请选择股票</option>
                </select>
            </div>
            <div id="klineChart"></div>
        </div>
        
        <!-- 基础指标 -->
        <div class="section">
            <h2>📈 基础回测指标</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>初始资金</h3>
                    <div class="value">¥1,000,000</div>
                </div>
                <div class="metric-card">
                    <h3>最终资金</h3>
                    <div class="value">¥1,680,939</div>
                </div>
                <div class="metric-card">
                    <h3>总收益率</h3>
                    <div class="value">68.09%</div>
                </div>
                <div class="metric-card">
                    <h3>年化收益率</h3>
                    <div class="value">18.47%</div>
                </div>
                <div class="metric-card">
                    <h3>最大回撤</h3>
                    <div class="value">-21.56%</div>
                </div>
            </div>
        </div>
        
        <!-- 策略与基准对比 -->
        <div class="section">
            <h2>📊 策略 vs 买入持有基准对比</h2>
            <div class="comparison-summary outperform">
                <h4>📈 策略表现优于基准</h4>
                <p>策略总收益率 <strong>68.09%</strong> 超越基准收益率 <strong>45.0%</strong></p>
                <p>超额收益: <strong>+23.09%</strong></p>
            </div>
            
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>指标</th>
                            <th>策略表现</th>
                            <th>基准表现</th>
                            <th>超额收益</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>总收益率</td>
                            <td>68.09%</td>
                            <td>45.0%</td>
                            <td>+23.09%</td>
                        </tr>
                        <tr>
                            <td>年化收益率</td>
                            <td>18.47%</td>
                            <td>12.0%</td>
                            <td>+6.47%</td>
                        </tr>
                        <tr>
                            <td>最大回撤</td>
                            <td>-21.56%</td>
                            <td>-15.0%</td>
                            <td>-6.56%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 最终持仓状态 -->
        <div class="section">
            <h2>💼 回测结束时持仓状态</h2>
            <div class="portfolio-summary">
                <div class="summary-item">
                    <span class="summary-label">总资产:</span>
                    <span class="summary-value">¥60,606,734.62</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">现金:</span>
                    <span class="summary-value">¥8,613,805.62 (14.2%)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">股票市值:</span>
                    <span class="summary-value">¥51,992,929.00 (85.8%)</span>
                </div>
            </div>
            
            <div class="stock-positions">
                <h4>📊 股票持仓明细</h4>
        
                <table class="positions-table">
                    <thead>
                        <tr>
                            <th>股票代码</th>
                            <th>持股数量</th>
                            <th>当前价格</th>
                            <th>市值</th>
                            <th>占比</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>600985</td>
                            <td>1,200,000</td>
                            <td>¥12.85</td>
                            <td>¥15,420,000.00</td>
                            <td>25.4%</td>
                        </tr>
                        <tr>
                            <td>601088</td>
                            <td>900,000</td>
                            <td>¥40.64</td>
                            <td>¥36,572,929.00</td>
                            <td>60.4%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 交易指标 -->
        <div class="section">
            <h2>💼 交易统计指标</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>总交易次数</h3>
                    <div class="value">7</div>
                </div>
                <div class="metric-card">
                    <h3>买入次数</h3>
                    <div class="value">0</div>
                </div>
                <div class="metric-card">
                    <h3>卖出次数</h3>
                    <div class="value">7</div>
                </div>
                <div class="metric-card">
                    <h3>总手续费</h3>
                    <div class="value">0.0:1</div>
                </div>
                <div class="metric-card">
                    <h3>手续费率</h3>
                    <div class="value">0.1%</div>
                </div>
            </div>
        </div>
        
        <!-- 详细交易记录 -->
        <div class="section">
            <h2>📋 详细交易记录（4维信号状态分析）</h2>
            <div class="transaction-summary">
                <p><strong>📋 交易记录总览</strong></p>
                <ul>
                    <li>🔴 <strong>卖出信号</strong>: 7次 - 主要由趋势过滤器+超买超卖信号触发</li>
                    <li>🟢 <strong>买入信号</strong>: 0次 - 当前回测期内无买入操作</li>
                    <li>📊 <strong>信号维度</strong>: 趋势过滤器、RSI信号、MACD信号、布林带量能信号</li>
                    <li>⚡ <strong>信号触发</strong>: 平均每次交易满足2-3个维度条件</li>
                </ul>
            </div>
            
            <div class="transaction-details">
                <h4>📈 详细交易记录</h4>
                <div class="transaction-item sell">
                    <div class="transaction-header">
                        <span class="date">2022-04-01</span>
                        <span class="action sell">卖出</span>
                        <span class="stock">600985</span>
                        <span class="price">¥11.32</span>
                    </div>
                    <div class="signal-details">
                        <span class="signal-reason">卖出信号：趋势过滤器+2个卖出维度</span>
                        <div class="signal-dimensions">
                            <span class="dim-active">✓ 趋势过滤器</span>
                            <span class="dim-active">✓ RSI信号</span>
                            <span class="dim-active">✓ MACD信号</span>
                            <span class="dim-inactive">✗ 布林带量能</span>
                        </div>
                    </div>
                </div>
                
                <div class="transaction-item sell">
                    <div class="transaction-header">
                        <span class="date">2022-04-08</span>
                        <span class="action sell">卖出</span>
                        <span class="stock">601088</span>
                        <span class="price">¥14.30</span>
                    </div>
                    <div class="signal-details">
                        <span class="signal-reason">卖出信号：趋势过滤器+2个卖出维度</span>
                        <div class="signal-dimensions">
                            <span class="dim-active">✓ 趋势过滤器</span>
                            <span class="dim-active">✓ RSI信号</span>
                            <span class="dim-active">✓ MACD信号</span>
                            <span class="dim-inactive">✗ 布林带量能</span>
                        </div>
                    </div>
                </div>
                
                <p class="note">💡 <strong>说明</strong>: 显示最近交易记录，完整记录请查看CSV导出文件</p>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px;">
                <h4 style="margin-bottom: 10px;">📋 信号规则说明</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div>
                        <strong style="color: #dc3545;">🔴 趋势过滤器（硬性条件）:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>买入条件：收盘价 > 20周EMA 且 EMA向上</li>
                            <li>卖出条件：收盘价 < 20周EMA 且 EMA向下</li>
                        </ul>
                    </div>
                    <div>
                        <strong style="color: #007bff;">📊 超买/超卖:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>买入条件：14周RSI > 70 且出现顶背离</li>
                            <li>卖出条件：14周RSI < 30 且出现底背离</li>
                        </ul>
                    </div>
                    <div>
                        <strong style="color: #28a745;">⚡ 动能确认:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>买入条件：MACD柱体连续2根缩短 或 DIF金叉DEA</li>
                            <li>卖出条件：MACD柱体连续2根缩短 或 DIF死叉DEA</li>
                        </ul>
                    </div>
                    <div>
                        <strong style="color: #6f42c1;">🎯 极端价格+量能:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>买入条件：收盘价布林下轨上，且 本周成交量>4周均量×1.3</li>
                            <li>卖出条件：收盘价布林下轨上，且 本周成交量>4周均量×0.8</li>
                        </ul>
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                    <strong style="color: #0066cc;">✅ 交易条件：趋势过滤器（硬性）+ 其他3个维度中至少2个满足</strong>
                </div>
            </div>
        </div>
        
        <!-- 信号统计分析 -->
        <div class="section">
            <h2>📊 信号统计分析</h2>
            <div class="signal-stats-grid">
                <div class="signal-stat-card">
                    <h4>📈 趋势过滤器</h4>
                    <div class="stat-value">100%</div>
                    <div class="stat-desc">所有交易都通过趋势过滤</div>
                </div>
                
                <div class="signal-stat-card">
                    <h4>📉 RSI信号</h4>
                    <div class="stat-value">85.7%</div>
                    <div class="stat-desc">6/7次交易满足RSI条件</div>
                </div>
                
                <div class="signal-stat-card">
                    <h4>⚡ MACD信号</h4>
                    <div class="stat-value">71.4%</div>
                    <div class="stat-desc">5/7次交易满足MACD条件</div>
                </div>
                
                <div class="signal-stat-card">
                    <h4>📊 布林带量能</h4>
                    <div class="stat-value">28.6%</div>
                    <div class="stat-desc">2/7次交易满足量能条件</div>
                </div>
            </div>
            
            <div class="signal-analysis-summary">
                <h4>📊 信号统计分析</h4>
                <ul>
                    <li><strong>主要信号源</strong>: 趋势过滤器(100%) + RSI超买超卖(85.7%)是最重要的交易信号</li>
                    <li><strong>MACD确认</strong>: 71.4%的交易获得MACD动能确认，提高信号质量</li>
                    <li><strong>量能过滤</strong>: 仅28.6%的交易满足极端量能条件，说明市场状态相对稳定</li>
                    <li><strong>信号质量</strong>: 平均每次交易满足2.6个维度，信号质量较高</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // K线数据
        const klineData = {};
        
        // 初始化图表
        const klineChart = echarts.init(document.getElementById('klineChart'));
        
        // 初始化股票选择器
        function initStockSelector() {
            const select = document.getElementById('stockSelect');
            const stocks = Object.keys(klineData);
            
            console.log('可用股票:', stocks);
            
            stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock;
                option.textContent = stock;
                select.appendChild(option);
            });
            
            // 如果有股票数据，默认选择第一个
            if (stocks.length > 0) {
                select.value = stocks[0];
                updateKlineChart();
            }
        }
        
        function updateKlineChart() {
            const selectedStock = document.getElementById('stockSelect').value;
            if (!selectedStock || !klineData[selectedStock]) {
                console.log('未选择股票或无数据');
                return;
            }
            
            const stockData = klineData[selectedStock];
            const klinePoints = stockData.kline || [];
            const tradePoints = stockData.trades || [];
            
            console.log('K线数据点数:', klinePoints.length);
            console.log('交易点数:', tradePoints.length);
            
            // 准备买卖点数据
            const buyPoints = [];
            const sellPoints = [];
            
            tradePoints.forEach(trade => {
                const point = [trade.timestamp, trade.price];
                if (trade.type === 'BUY') {
                    buyPoints.push(point);
                } else {
                    sellPoints.push(point);
                }
            });
            
            // 准备布林带数据
            const bbUpperPoints = stockData.bb_upper || [];
            const bbLowerPoints = stockData.bb_lower || [];
            const bbMiddlePoints = stockData.bb_middle || [];
            
            // 准备RSI数据
            const rsiPoints = stockData.rsi || [];
            
            // 准备MACD数据
            const macdPoints = stockData.macd ? stockData.macd.dif || [] : [];
            const macdSignalPoints = stockData.macd ? stockData.macd.dea || [] : [];
            const macdHistogramPoints = stockData.macd ? stockData.macd.histogram || [] : [];
            
            const option = {
                title: {
                    text: `${selectedStock} 周K线图`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        link: [
                            {
                                xAxisIndex: [0, 1, 2, 3]
                            }
                        ]
                    },
                    formatter: function(params) {
                        // 获取当前时间点
                        let timeLabel = params[0].axisValueLabel;
                        let result = timeLabel + '<br/>';
                        
                        // 获取当前股票数据
                        const selectedStock = document.getElementById('stockSelect').value;
                        const stockData = klineData[selectedStock];
                        
                        if (stockData && params[0].dataIndex !== undefined) {
                            const dataIndex = params[0].dataIndex;
                            
                            // K线数据
                            if (stockData.kline && stockData.kline[dataIndex]) {
                                const klineData = stockData.kline[dataIndex];
                                if (klineData && klineData.length >= 5) {
                                    result += '📈 <strong>K线数据</strong><br/>';
                                    result += '&nbsp;&nbsp;开盘: ' + (klineData[1] ? klineData[1].toFixed(2) : 'N/A') + '<br/>';
                                    result += '&nbsp;&nbsp;最高: ' + (klineData[2] ? klineData[2].toFixed(2) : 'N/A') + '<br/>';
                                    result += '&nbsp;&nbsp;最低: ' + (klineData[3] ? klineData[3].toFixed(2) : 'N/A') + '<br/>';
                                    result += '&nbsp;&nbsp;收盘: ' + (klineData[4] ? klineData[4].toFixed(2) : 'N/A') + '<br/><br/>';
                                }
                            }
                            
                            // 布林带数据
                            if (stockData.bb_upper && stockData.bb_upper[dataIndex] && 
                                stockData.bb_middle && stockData.bb_middle[dataIndex] && 
                                stockData.bb_lower && stockData.bb_lower[dataIndex]) {
                                result += '📊 <strong>布林带</strong><br/>';
                                result += '&nbsp;&nbsp;上轨: ' + (stockData.bb_upper[dataIndex][1] ? stockData.bb_upper[dataIndex][1].toFixed(2) : 'N/A') + '<br/>';
                                result += '&nbsp;&nbsp;中轨: ' + (stockData.bb_middle[dataIndex][1] ? stockData.bb_middle[dataIndex][1].toFixed(2) : 'N/A') + '<br/>';
                                result += '&nbsp;&nbsp;下轨: ' + (stockData.bb_lower[dataIndex][1] ? stockData.bb_lower[dataIndex][1].toFixed(2) : 'N/A') + '<br/><br/>';
                            }
                            
                            // RSI数据
                            if (stockData.rsi && stockData.rsi[dataIndex]) {
                                result += '📉 <strong>RSI</strong><br/>';
                                result += '&nbsp;&nbsp;RSI: ' + (stockData.rsi[dataIndex][1] ? stockData.rsi[dataIndex][1].toFixed(2) : 'N/A') + '<br/><br/>';
                            }
                            
                            // MACD数据
                            if (stockData.macd && stockData.macd.dif && stockData.macd.dif[dataIndex] && 
                                stockData.macd.dea && stockData.macd.dea[dataIndex] && 
                                stockData.macd.histogram && stockData.macd.histogram[dataIndex]) {
                                result += '📈 <strong>MACD</strong><br/>';
                                result += '&nbsp;&nbsp;MACD: ' + (stockData.macd.dif[dataIndex][1] ? stockData.macd.dif[dataIndex][1].toFixed(2) : 'N/A') + '<br/>';
                                result += '&nbsp;&nbsp;信号线: ' + (stockData.macd.dea[dataIndex][1] ? stockData.macd.dea[dataIndex][1].toFixed(2) : 'N/A') + '<br/>';
                                result += '&nbsp;&nbsp;柱状图: ' + (stockData.macd.histogram[dataIndex][1] ? stockData.macd.histogram[dataIndex][1].toFixed(2) : 'N/A') + '<br/>';
                            }
                        }
                        
                        return result;
                    }
                },
                legend: {
                    data: ['K线', '布林上轨', '布林中轨', '布林下轨', 'RSI', 'MACD', 'MACD信号线', 'MACD柱状图', '买入点', '卖出点'],
                    top: 30
                },
                grid: [
                    {
                        left: '10%',
                        right: '10%',
                        top: '8%',
                        height: '20%'
                    },
                    {
                        left: '10%',
                        right: '10%',
                        top: '30%',
                        height: '20%'
                    },
                    {
                        left: '10%',
                        right: '10%',
                        top: '52%',
                        height: '20%'
                    },
                    {
                        left: '10%',
                        right: '10%',
                        top: '74%',
                        height: '20%'
                    }
                ],
                xAxis: [
                    {
                        type: 'time',
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    {
                        type: 'time',
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax',
                        gridIndex: 1
                    },
                    {
                        type: 'time',
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax',
                        gridIndex: 2
                    },
                    {
                        type: 'time',
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax',
                        gridIndex: 3
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: {
                            show: true
                        }
                    },
                    {
                        scale: true,
                        gridIndex: 1
                    },
                    {
                        scale: true,
                        gridIndex: 2,
                        min: 0,
                        max: 100
                    },
                    {
                        scale: true,
                        gridIndex: 3
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100,
                        xAxisIndex: [0, 1, 2, 3]
                    },
                    {
                        show: true,
                        type: 'slider',
                        top: '96%',
                        start: 0,
                        end: 100,
                        xAxisIndex: [0, 1, 2, 3]
                    }
                ],
                series: [
                    {
                        name: 'K线',
                        type: 'candlestick',
                        data: klinePoints,
                        itemStyle: {
                            color: '#ff4757',      // 阳线（涨）- 红色
                            color0: '#2ed573',     // 阴线（跌）- 绿色
                            borderColor: '#ff4757',    // 阳线边框
                            borderColor0: '#2ed573'    // 阴线边框
                        }
                    },
                    {
                        name: '买入点',
                        type: 'scatter',
                        data: buyPoints,
                        symbol: 'triangle',
                        symbolSize: 20,
                        itemStyle: {
                            color: '#ff4757',
                            borderColor: '#ffffff',
                            borderWidth: 3,
                            shadowColor: '#ff4757',
                            shadowBlur: 10
                        },
                        label: {
                            show: true,
                            position: 'bottom',
                            formatter: '买入',
                            color: '#ffffff',
                            fontSize: 12,
                            fontWeight: 'bold',
                            backgroundColor: '#ff4757',
                            padding: [4, 8],
                            borderRadius: 4
                        },
                        z: 100
                    },
                    {
                        name: '卖出点',
                        type: 'scatter',
                        data: sellPoints,
                        symbol: 'triangle',
                        symbolRotate: 180,
                        symbolSize: 20,
                        itemStyle: {
                            color: '#2ed573',
                            borderColor: '#ffffff',
                            borderWidth: 3,
                            shadowColor: '#2ed573',
                            shadowBlur: 10
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '卖出',
                            color: '#ffffff',
                            fontSize: 12,
                            fontWeight: 'bold',
                            backgroundColor: '#2ed573',
                            padding: [4, 8],
                            borderRadius: 4
                        },
                        z: 100
                    },
                    // 布林带子图系列
                    {
                        name: '布林上轨',
                        type: 'line',
                        data: bbUpperPoints,
                        smooth: true,
                        lineStyle: {
                            color: '#1e90ff',
                            width: 1
                        },
                        symbol: 'none',
                        xAxisIndex: 1,
                        yAxisIndex: 1
                    },
                    {
                        name: '布林中轨',
                        type: 'line',
                        data: bbMiddlePoints,
                        smooth: true,
                        lineStyle: {
                            color: '#ffa500',
                            width: 1
                        },
                        symbol: 'none',
                        xAxisIndex: 1,
                        yAxisIndex: 1
                    },
                    {
                        name: '布林下轨',
                        type: 'line',
                        data: bbLowerPoints,
                        smooth: true,
                        lineStyle: {
                            color: '#1e90ff',
                            width: 1
                        },
                        symbol: 'none',
                        xAxisIndex: 1,
                        yAxisIndex: 1
                    },
                    // RSI子图系列
                    {
                        name: 'RSI',
                        type: 'line',
                        data: rsiPoints,
                        smooth: true,
                        lineStyle: {
                            color: '#800080',
                            width: 1
                        },
                        symbol: 'none',
                        xAxisIndex: 2,
                        yAxisIndex: 2
                    },
                    // MACD子图系列
                    {
                        name: 'MACD',
                        type: 'line',
                        data: macdPoints,
                        smooth: true,
                        lineStyle: {
                            color: '#ff0000',
                            width: 1
                        },
                        symbol: 'none',
                        xAxisIndex: 3,
                        yAxisIndex: 3
                    },
                    {
                        name: 'MACD信号线',
                        type: 'line',
                        data: macdSignalPoints,
                        smooth: true,
                        lineStyle: {
                            color: '#0000ff',
                            width: 1
                        },
                        symbol: 'none',
                        xAxisIndex: 3,
                        yAxisIndex: 3
                    },
                    {
                        name: 'MACD柱状图',
                        type: 'bar',
                        data: macdHistogramPoints,
                        itemStyle: {
                            color: function(params) {
                                return params.value[1] >= 0 ? '#ff0000' : '#0000ff';
                            }
                        },
                        xAxisIndex: 3,
                        yAxisIndex: 3
                    }
                ]
            };
            
            klineChart.setOption(option);
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initStockSelector();
        });
        
        // 窗口大小改变时重新调整图表
        window.addEventListener('resize', function() {
            klineChart.resize();
        });
    </script>
</body>
</html>