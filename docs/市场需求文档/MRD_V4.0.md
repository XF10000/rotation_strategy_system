### **中线行业轮动策略市场需求文档 (MRD) - V4.0**

**版本**: 4.0
**日期**: 2025-08-11
**状态**: **定稿**
**更新内容**: 新增动态仓位管理系统

### 1. 产品概述

#### 1.1. 产品愿景
打造一个**智能、自适应**的中线量化交易策略系统。该系统旨在通过结合**基本面价值筛选**、**多维度技术择时**与**动态仓位管理**，在申万二级行业的轮动中，持续捕捉高确定性的交易机会。

#### 1.2. 核心理念
策略的基石是"先选好公司，再等好时机，最后用对仓位"。我们坚信，只有在**价值合理**的前提下，技术信号才有意义，而**动态仓位管理**则确保在不同估值水平下采用最优的资金配置策略。因此，本策略以**价值比率**作为硬性准入门槛，辅以一套**数据驱动的动态信号系统**进行精准择时，并通过**基于估值的动态仓位管理**实现风险可控的资金配置。

#### 1.3. 目标用户
- **产品经理**: 理解策略核心逻辑与竞争优势。
- **技术负责人**: 把握系统架构、模块划分与技术实现。
- **量化分析师**: 使用并优化策略参数，进行深度归因分析。

---

### 2. 核心策略逻辑：4D决策框架 + 动态仓位管理

策略的决策核心是一个四维信号系统，它以层层递进的方式进行过滤和确认，以确保信号的高质量。在信号确认后，系统采用基于估值水平的动态仓位管理策略。

#### **维度一：价值准入过滤器 (硬性前提)**
这是信号系统的**唯一硬性前提**，所有交易机会必须首先通过此关。

- **主规则**: 基于DCF（现金流折现）估值计算**价值比率** (`当前价格 / DCF估值`)。
  - **买入条件**: `价值比率 < 80%` (处于低估区间)
  - **卖出条件**: `价值比率 > 70%` (处于高估或合理区间)
- **兼容性回退**: 当目标缺少DCF估值数据时，系统自动无缝切换到**"20周EMA趋势过滤器"**，确保策略的普适性。

#### **维度二、三、四：技术择时信号 (三者取二)**
在满足【维度一】的前提下，以下三个技术维度中**至少满足两个**，才能最终触发交易信号。

- **维度二：超买超卖 (动态RSI系统)**
  - **技术参数**: RSI周期14周，124个申万二级行业特定阈值
  - **机制**: 摒弃固定的30/70阈值，采用一套**数据驱动的动态阈值系统**。该系统通过分析行业历史波动率，自动将行业分为"高/中/低"三层，并根据其历史RSI分布的**分位数**来计算超买超卖阈值。
  - **信号**:
    - **普通信号**: RSI触达为该行业计算出的普通阈值，且出现价格背离（比较最近3周）。
    - **极端信号**: RSI触达更严格的极端阈值，**此时无需背离**，直接触发。

- **维度三：动能确认 (MACD)**
  - **技术参数**: 快线12周，慢线26周，信号线9周
  - **机制**: 判断市场动能的转换。
  - **信号**:
    - **买入**: MACD绿色柱体（HIST<0）连续2根缩短，或柱体翻红（HIST由负转正），或DIF金叉DEA。
    - **卖出**: MACD红色柱体（HIST>0）连续2根缩短，或柱体翻绿（HIST由正转负），或DIF死叉DEA。

- **维度四：极端价格+量能 (布林带 + 成交量)**
  - **机制**: 捕捉由资金驱动的极端情绪爆发点。
  - **技术参数**:
    - 布林带：20周期，2倍标准差
    - 成交量均线：4周均量
    - 量能倍数：买入0.8倍，卖出1.3倍
  - **信号**:
    - **买入**: 收盘价 ≤ 布林下轨 且 本周成交量 ≥ 4周均量 × 0.8
    - **卖出**: 收盘价 ≥ 布林上轨 且 本周成交量 ≥ 4周均量 × 1.3

#### **🆕 动态仓位管理系统**
在4D信号确认后，系统不再使用固定的轮动比例，而是根据股票的估值水平动态调整买卖数量。

##### **买入仓位策略**
基于价值比(`当前价格/DCF估值`)动态调整买入比例，严格控制单只股票总仓位风险：

**第一步：基于估值水平确定基础买入金额**

- **极度低估 (≤60%)**:
  - 有持仓：如果现金≥50%当前持仓价值，加仓50%当前持仓价值；现金<50%当前持仓价值，加仓现金价值的80%
  - 无持仓：如果现金≥15%总资产，买入15%总资产的仓位；如果现金<15%总资产，买入现金价值的80%
  - 单笔上限：15%总资产

- **明显低估 (60%-70%)**:
  - 有持仓：如果现金≥20%当前持仓价值，加仓20%当前持仓价值；现金<20%当前持仓价值，加仓现金价值的80%
  - 无持仓：如果现金≥10%总资产，买入10%总资产的仓位；如果现金<10%总资产，买入现金价值的80%
  - 单笔上限：10%总资产

- **轻度低估 (70%-80%)**:
  - 有持仓：如果现金≥10%当前持仓价值，加仓10%当前持仓价值；现金<10%当前持仓价值，加仓现金价值的80%
  - 无持仓：如果现金≥5%总资产，买入5%总资产的仓位；如果现金<5%总资产，买入现金价值的80%
  - 单笔上限：5%总资产

**第二步：应用总仓位限制**
- **硬性约束**：单只股票总仓位不得超过总资产的20%
- **最终买入金额** = min(基础买入金额, 20%总资产 - 当前持仓价值)
- **保护机制**：如果当前持仓已达到或超过20%，则跳过买入操作

**示例说明**：
- 总资产100万，某股票当前持仓10万，现金30万
- 该股票价值比50%（极度低估）
- 第一步：现金30万 ≥ 50%持仓价值(5万)，所以加仓50%持仓价值 = 5万
- 第二步：当前10万 + 5万 = 15万 < 20万(20%总资产)，通过总仓位检查
- 最终买入：5万元

##### **卖出仓位策略**
基于价值比动态调整卖出比例：

- **极度高估 (>120%)**: 减仓100% (全部卖出)
- **轻度高估 (100%-120%)**: 减仓80%
- **合理区间 (80%-100%)**: 减仓50%
- **轻度低估 (70%-80%)**: 减仓20%

##### **风险控制机制**
- **单股总仓位上限**: 20%总资产（核心约束）
- **单笔交易上限**: 根据估值水平分别为5%/10%/15%总资产
- **最小交易单位**: 100股整数倍
<!-- - **最小交易金额**: 10,000元 -->
<!-- - **现金安全垫**: 保持至少5%总资产的现金储备 -->

---

### 3. 系统架构与交付物

#### 3.1. 系统核心组件
- **回测引擎 (`BacktestEngine`)**: 负责数据加载（内置智能缓存）、回测流程调度、与信号生成器和动态仓位管理器的交互。
- **信号生成器 (`SignalGenerator`)**: 封装完整的4D决策框架逻辑。
- **🆕 动态仓位管理器 (`DynamicPositionManager`)**: 基于估值水平的智能仓位管理模块。
- **动态RSI阈值模块 (`sw_rsi_thresholds/`)**: 一个独立的预处理模块，负责定期计算并生成最新的行业RSI阈值CSV文件，供回测引擎调用。

#### 3.2. 关键交付物
- **可执行的回测框架**: 一整套Python代码，可直接运行。
- **详尽的回测报告**:
  - **HTML报告**: 提供资金曲线、夏普比率、最大回撤等关键指标的可视化概览，包含K线图和技术指标面板。
  - **CSV报告**: 提供每一笔交易的明细，包括触发交易时所有四个维度的详细状态、价值比分析、动态仓位决策依据，便于深度归因分析。
  - **🆕 分红配股事件报告**: 详细记录所有分红配股事件的处理情况。
- **完备的文档**: 包括本MRD、用户使用指南和代码注释。

---

### 4. 技术特性与优势

#### 4.1. 🆕 动态仓位管理优势
- **估值驱动**: 告别盲目的固定比例交易，根据股票实际估值水平智能决策
- **风险可控**: 高估时主动减仓，低估时积极加仓，实现逆向投资
- **资金效率**: 根据机会质量动态配置资金，提高资金使用效率
- **风险分散**: 通过仓位上限和现金安全垫控制单一标的风险

#### 4.2. 行业差异化处理
- **124个申万二级行业**: 每个行业使用专属的RSI阈值，更精准判断超买超卖
- **动态阈值更新**: 基于历史数据的分位数计算，自适应市场变化
- **行业轮动逻辑**: 在行业层面进行轮动，捕捉结构性机会

#### 4.3. 数据处理与缓存
- **智能缓存系统**: 自动管理历史数据缓存，显著提升回测性能
- **多源数据融合**: 整合akshare等多个数据源，确保数据完整性
- **分红配股处理**: 自动处理复权数据，确保回测准确性

#### 4.4. 可视化与分析
- **交互式K线图**: 集成技术指标、交易点标记、分红事件标记
- **多维度分析**: 4个信号维度的详细状态记录和分析
- **基准对比**: 与买入持有策略的详细对比分析

---

### 5. 版本更新记录

#### V4.0 (2025-08-11) - 动态仓位管理系统
- **新增**: 基于价值比的动态仓位管理系统
- **优化**: 交易决策从固定比例升级为估值驱动
- **增强**: 风险控制机制和资金配置效率
- **完善**: 分红配股事件的完整处理和记录

#### V3.0 (2025-08-09) - 多维信号系统
- **新增**: 4维信号决策框架
- **优化**: 动态RSI阈值系统
- **增强**: 行业差异化处理能力

---

### 6. 未来发展方向

#### 6.1. 短期优化 (1-3个月)
- **参数自适应**: 基于市场环境自动调整动态仓位管理参数
- **止损机制**: 增加基于技术指标的止损保护
- **多周期融合**: 整合日线和月线信号，提高决策准确性

#### 6.2. 中期扩展 (3-6个月)
- **机器学习增强**: 使用ML模型优化信号权重和仓位分配
- **情绪指标**: 整合市场情绪和资金流向数据
- **组合优化**: 基于现代投资组合理论的资产配置优化

#### 6.3. 长期愿景 (6-12个月)
- **多市场扩展**: 支持港股、美股等多市场轮动
- **实盘交易**: 对接券商API，支持自动化实盘交易
- **风险管理**: 完整的风险管理和合规监控体系

---

**文档维护**: 本文档将随着系统功能的迭代持续更新，确保需求描述与实际功能保持一致。