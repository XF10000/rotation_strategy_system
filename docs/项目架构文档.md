# 中线轮动策略回测系统 - 架构文档

## 1. 整体需求与目标

本项目是一个专为A股市场设计的中线量化交易策略回测系统。其核心目标是提供一个强大、灵活且易于使用的工具，用于验证和分析一个基于多维度信号的股票轮动策略。

### 关键需求：

*   **配置驱动**: 系统的所有核心参数，包括股票池、回测周期、初始资金和策略规则，都必须通过外部CSV文件进行配置，实现代码与配置的分离。
*   **复杂的信号系统**: 策略的核心是一个“4维信号系统”，它必须结合价值、情绪、动能和统计学等多个维度进行综合判断，以提高信号的准确性。
*   **动态与个性化**: 策略参数（特别是RSI阈值）应能根据不同行业的特性进行动态调整，而不是全局使用固定值。
*   **数据处理的鲁棒性**: 系统必须能够智能处理数据，包括：
    *   高效的本地缓存机制，避免重复下载。
    *   自动处理分红、送股等公司行为对价格的影响。
    *   在计算技术指标前，自动加载足够的历史数据进行“预热”，保证指标的准确性。
*   **详尽的结果分析**: 回测结束后，系统需要生成内容详尽、易于理解的报告，包括：
    *   关键性能指标（总收益率、年化收益、最大回撤等）。
    *   每一笔交易的详细记录，包含当时的各项技术指标状态。
    *   交互式的K线图，并在图上标注买卖点。

## 2. 代码架构

系统采用分层、模块化的架构设计，职责清晰，耦合度低，易于维护和扩展。

### 2.1 核心分层

1.  **配置层 (`config/`, `Input/`)**
    *   **职责**: 提供所有可配置的参数。
    *   **核心**: `config/csv_config_loader.py` 负责读取 `Input/` 目录下的CSV文件，并将其与代码中的默认参数合并，形成统一的配置对象。

2.  **主控/引擎层 (`main.py`, `backtest/`)**
    *   **职责**: 驱动整个回测流程，是系统的“指挥官”。
    *   **核心**: `backtest/backtest_engine.py` 接收配置对象，按时间顺序（周）推进回测，并协调数据、策略、账户管理等所有模块的工作。

3.  **策略层 (`strategy/`)**
    *   **职责**: 实现交易决策逻辑，是系统的“大脑”。
    *   **核心**: `strategy/signal_generator.py` 实现了复杂的4维信号系统。它接收市场数据，输出明确的买入/卖出/持有信号，完全独立于其他业务逻辑。

4.  **数据层 (`data/`, `indicators/`)**
    *   **职责**: 提供稳定、准确的数据支持。
    *   **核心**: `data/data_fetcher.py` 负责从外部源获取数据。`data/data_processor.py` 负责数据清洗和技术指标计算（调用 `indicators/` 目录下的函数）。`data/data_storage.py` 负责本地缓存的读写。

5.  **报告层 (`backtest/`, `reports/`)**
    *   **职责**: 对回测结果进行分析和可视化。
    *   **核心**: `backtest/performance_analyzer.py` 计算各项性能指标。`backtest/enhanced_report_generator_integrated_fixed.py` 负责将所有结果数据填充到HTML模板中，生成最终的交互式报告。

### 2.2 数据流转过程

1.  **启动**: `main.py` 启动，调用配置层生成 `config` 对象。
2.  **注入与准备**: `config` 对象被注入 `BacktestEngine`。引擎根据配置，命令数据层准备数据（优先读缓存，否则下载并处理），加载DCF、行业RSI等策略所需数据。
3.  **回测循环**: 引擎按周为单位进行循环。
4.  **信号生成**: 在每一周，引擎将当前及历史数据喂给 `SignalGenerator`。
5.  **决策返回**: `SignalGenerator` 进行4维分析，返回 `BUY`/`SELL`/`HOLD` 信号给引擎。
6.  **交易执行**: 引擎根据信号命令 `PortfolioManager` 更新持仓和现金。
7.  **结果生成**: 循环结束后，引擎将所有过程数据交给报告层，生成最终的HTML和CSV报告。

## 3. 文件结构

以下是项目核心目录和文件的功能说明：

```
.
├── Input/                    # 用户配置目录
│   ├── portfolio_config.csv  # 定义股票池、初始权重、DCF估值
│   └── Backtest_settings.csv # 定义回测周期、资金、策略参数
│
├── main.py                   # ✅ 项目主入口，启动回测
│
├── backtest/                 # 核心回测逻辑
│   ├── backtest_engine.py    # 🚀 回测引擎，流程总指挥
│   ├── signal_generator.py   # 🧠 4维信号生成器，策略核心
│   ├── portfolio_manager.py  # 💼 投资组合管理器，管理持仓和现金
│   └── enhanced_report_generator... # 📊 HTML报告生成器
│
├── data/                     # 数据处理
│   ├── data_fetcher.py       # 📡 数据获取器 (Akshare)
│   ├── data_processor.py     # 🔧 数据处理器 (计算指标、转周期)
│   └── data_storage.py       # 💾 缓存管理器
│
├── data_cache/               # 缓存数据存放目录 (自动生成)
│
├── indicators/               # 技术指标计算库
│   ├── trend.py              # 趋势指标 (EMA)
│   ├── momentum.py           # 动量指标 (RSI, MACD)
│   ├── volatility.py         # 波动率指标 (布林带)
│   └── divergence.py         # 📈 背离检测逻辑
│
├── config/                   # 内部配置与加载器
│   ├── csv_config_loader.py  # CSV配置加载与合并逻辑
│   └── ...                   # 其他默认配置文件
│
├── reports/                  # 回测报告输出目录 (自动生成)
│
├── sw_rsi_thresholds/        # 申万行业RSI动态阈值数据
│
└── utils/                    # 辅助工具脚本
    ├── industry_mapper.py    # 股票-行业映射生成工具
    └── ...
```
