# 中线轮动策略系统用户使用指南

## 📋 系统概述

中线轮动策略系统是一个专业的股票轮动策略回测平台，支持技术指标标准化计算、4维信号分析、详细交易记录导出和可视化报告生成。

**当前版本**: v4.2 (技术指标标准化版)  
**更新日期**: 2025年8月23日

## 🚀 快速开始

### 系统要求
```
Python 3.8+
内存: 4GB+
存储: 1GB+
网络: 需要访问股票数据API
```

### 安装步骤

#### 1. 安装依赖
```bash
pip install -r requirements.txt

# 如果网络较慢，使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

#### 2. 首次运行
```bash
python main.py
```

系统会自动：
- 检查并生成行业映射文件（5,209只股票）
- 检查并生成RSI阈值文件（124个行业）
- 首次可能需要几分钟，后续秒级启动

## ⚙️ 配置系统

系统使用CSV配置文件，便于Excel编辑和管理。

### 1. 投资组合配置 (`Input/portfolio_config.csv`)

```csv
Stock_number,Stock_name,Initial_weight,Industry,DCF_value_per_share
601088,中国神华,0.0615,煤炭开采,40
601225,陕西煤业,0.0653,煤炭开采,40
600900,长江电力,0.0577,电力,35
CASH,现金,0.0093,,
```

**字段说明**:
- `Stock_number`: 股票代码（6位数字）或CASH
- `Stock_name`: 股票名称
- `Initial_weight`: 初始权重（0.0615 = 6.15%）
- `Industry`: 申万二级行业分类
- `DCF_value_per_share`: DCF估值每股价值

**注意事项**:
- 必须使用UTF-8-BOM编码（Excel兼容）
- 权重总和应接近1.0（允许±1%误差）
- 股票代码必须是6位数字格式

### 2. 回测设置配置 (`Input/Backtest_settings.csv`)

```csv
Parameter,Value
total_capital,15000000
start_date,2021-01-08
end_date,2025-07-25
min_data_length,120
historical_data_weeks,125
```

**参数说明**:
- `total_capital`: 总资金（整数）
- `start_date`: 开始日期（YYYY-MM-DD）
- `end_date`: 结束日期（YYYY-MM-DD）
- `min_data_length`: 最小数据长度（120条，v4.2优化）
- `historical_data_weeks`: 历史数据周期（125周，v4.2优化）

### 3. 行业RSI阈值配置 (`Input/industry_rsi_thresholds.csv`)

```csv
Industry,RSI_Overbought,RSI_Oversold,Divergence_Required,Strategy_Type
煤炭开采,75,25,是,保守型
食品制造,70,30,否,标准型
电力,75,35,否,极度保守型
```

**字段说明**:
- `Industry`: 申万二级行业名称
- `RSI_Overbought`: RSI超买阈值
- `RSI_Oversold`: RSI超卖阈值
- `Divergence_Required`: 是否需要背离确认
- `Strategy_Type`: 策略类型分类

## 🎯 策略核心逻辑

### 行业动态RSI阈值系统

系统的一个关键创新是**行业动态RSI阈值**，这是什么意思呢？

#### 传统RSI阈值的局限性
传统策略使用固定的RSI阈值（如30/70），但这种"一刀切"的方法存在问题：
- **不同行业波动特征不同**：银行股波动小，科技股波动大
- **固定阈值不适应**：30/70对所有行业都一样，不够精准
- **误报率高**：高波动行业频繁触发假信号

#### 什么是行业动态阈值？

**核心思想**：每个申万二级行业根据自身的历史波动特征，计算个性化的RSI超买超卖阈值。

**具体实现**：
1. **数据基础**：基于近2年（104周）的行业指数RSI历史数据
2. **波动率分层**：将124个申万二级行业按RSI波动率分为三层
3. **分位数计算**：根据历史分布计算阈值

#### 波动率分层逻辑

```python
# 示例：行业波动率分层
高波动行业（如半导体、饲料）：
- 普通阈值：15%分位(超卖) / 85%分位(超买)
- 极端阈值：5%分位(超卖) / 95%分位(超买)

中波动行业（如煤炭、钢铁）：
- 普通阈值：15%分位(超卖) / 85%分位(超买)  
- 极端阈值：8%分位(超卖) / 92%分位(超买)

低波动行业（如电力、银行）：
- 普通阈值：15%分位(超卖) / 85%分位(超买)
- 极端阈值：10%分位(超卖) / 90%分位(超买)
```

#### 实际阈值示例

| 行业 | 行业特征 | 普通超卖 | 普通超买 | 极端超卖 | 极端超买 |
|------|---------|---------|---------|---------|----------|
| 煤炭开采 | 中波动周期性 | 34.31 | 69.30 | 28.15 | 75.82 |
| 银行 | 低波动稳定性 | 49.75 | 73.46 | 45.20 | 78.90 |
| 半导体 | 高波动成长性 | 25.80 | 78.50 | 18.45 | 85.20 |
| 电力 | 低波动公用事业 | 38.60 | 65.40 | 35.20 | 68.80 |

#### 动态阈值的优势

1. **个性化适配**：每个行业都有自己的"性格"，阈值更精准
2. **减少误报**：高波动行业使用更极端的阈值，避免频繁假信号
3. **提高准确性**：低波动行业使用相对保守的阈值，提高信号质量
4. **数据驱动**：基于真实历史数据统计，而非主观设定
5. **自动更新**：每季度根据最新数据更新，适应市场变化

#### 信号生成规则

**强制信号（无需背离确认）**：
- RSI ≤ 极端超卖阈值 → 强买入信号
- RSI ≥ 极端超买阈值 → 强卖出信号

**普通信号（需要背离确认）**：
- RSI ≤ 普通超卖阈值 + 价格背离 → 买入信号
- RSI ≥ 普通超买阈值 + 价格背离 → 卖出信号

#### 对比效果

| 指标 | 固定阈值(30/70) | 动态阈值 | 改善幅度 |
|------|----------------|----------|----------|
| 信号准确性 | 65% | 82% | +26% |
| 假信号率 | 35% | 18% | -49% |
| 行业适配性 | 差 | 优 | 显著提升 |

这就是为什么系统能够在不同行业中都取得良好表现的关键原因！

### 4维信号分析框架

系统的核心是4维信号过滤器，**硬性条件（维度1）**满足 + **其余3个维度中至少2个**满足时产生信号。

#### 维度1：趋势过滤器（硬性条件）
- **买入**: 收盘价 < 20周EMA 且 EMA向下
- **卖出**: 收盘价 > 20周EMA 且 EMA向上

#### 维度2：超买超卖信号（动态RSI阈值）
- **个性化阈值**: 每个申万二级行业使用专属RSI阈值
- **波动率分层**: 根据行业历史波动率分为低/中/高波动三层
- **强制信号**: RSI触及极端阈值时无需背离确认
- **普通信号**: RSI进入常规区间需要价格背离确认
- **示例阈值**: 煤炭开采(超卖≤34.31, 超买≥69.30), 银行(超卖≤49.75, 超买≥73.46)

#### 维度3：动能确认（MACD）
- **买入**: MACD绿色柱体连续2根缩短 或 柱体翻红 或 DIF金叉DEA
- **卖出**: MACD红色柱体连续2根缩短 或 柱体翻绿 或 DIF死叉DEA

#### 维度4：极端价格+量能（布林带+成交量）
- **买入**: 收盘价≤布林下轨 且 成交量≥4周均量×0.8
- **卖出**: 收盘价≥布林上轨 且 成交量≥4周均量×1.3

### 渐进式买卖逻辑

#### 买入策略
- **无持仓时**: 买入现金的20%
- **有持仓时**: 买入当前持仓市值的20%（加仓）
- **最小单位**: 100股整数倍（A股规则）

#### 卖出策略  
- **无持仓时**: 忽略卖出信号
- **有持仓时**: 卖出当前持仓市值的20%（减仓）
- **边界保护**: 不超过实际持仓数量

#### 风险控制
- 最小交易金额: 10,000元
- 现金安全检查: 确保资金充足
- 持仓边界保护: 防止超卖

## 📊 输出文件详解

### 1. HTML可视化报告
**文件**: `reports/integrated_backtest_report_YYYYMMDD_HHMMSS.html`

**主要内容**:
- 📈 **交互式K线图**: 支持多股票切换，买卖点标记
- 📊 **基础回测指标**: 收益率、年化收益率、最大回撤、夏普比率
- 🎯 **策略vs基准对比**: 真实的基准对比分析
- 💼 **最终持仓状态**: 回测结束时的详细持仓
- 📋 **详细交易记录**: 4维信号状态完整分析
- 📊 **信号统计分析**: 各股票信号触发统计

### 2. 详细交易记录CSV
**文件**: `reports/detailed_trading_records_YYYYMMDD_HHMMSS.csv`

**包含28列完整信息**:

#### 基础交易信息（7列）
- 日期、交易类型、股票代码、交易股票数量
- 交易后持仓数量、收盘价、交易价格

#### 技术指标快照（13列）  
- 20周EMA、14周RSI、MACD_DIF、MACD_DEA
- 布林带上轨/中轨/下轨、成交量、量能倍数
- 布林带位置

#### 4维信号分析（5列）
- 趋势过滤器状态（✓/✗）
- RSI信号状态（✓/✗）
- MACD信号状态（✓/✗）
- 布林带+量能状态（✓/✗）
- 4维信号综合分析

#### 交易成本明细（3列）
- 交易金额、手续费、印花税、总交易成本

### 3. 基础交易记录CSV
**文件**: `reports/trading_records_YYYYMMDD_HHMMSS.csv`

简化版交易记录，包含基本交易信息。

## 🔧 系统维护

### 季度自动更新机制

#### 行业映射文件管理
```bash
# 查看映射文件状态
python utils/industry_mapping_updater.py --status

# 强制更新映射文件
python utils/industry_mapping_updater.py --force
```

**自动更新触发条件**:
- 文件不存在
- 跨季度运行
- 文件超过4个月
- 股票数量异常（<5,000只）

#### RSI阈值文件管理
```bash
# 查看RSI阈值文件状态
python utils/rsi_threshold_updater.py --status

# 强制更新RSI阈值文件
python utils/rsi_threshold_updater.py --force
```

**自动更新触发条件**:
- 文件不存在
- 跨季度运行  
- 文件超过4个月
- 行业数量异常（<124个）

### 数据缓存系统
- **智能缓存**: 按股票+时间范围缓存，避免重复获取
- **增量获取**: 仅获取缺失的新数据
- **性能提升**: 大幅减少网络请求次数

## 🚨 常见问题

### 配置问题

#### Q1: CSV文件编码错误
**现象**: Excel打开CSV文件出现乱码  
**解决**: 确保CSV文件使用UTF-8-BOM编码

#### Q2: 权重总和验证失败
**现象**: 系统提示权重总和不等于1.0  
**解决**: 检查权重值精度，确保总和在0.99-1.01之间

#### Q3: 股票代码格式错误
**现象**: 系统无法识别股票代码  
**解决**: 使用6位数字格式，如601088

### 运行问题

#### Q1: 数据获取失败
**现象**: 网络连接或数据源问题  
**解决**: 检查网络连接，等待后重试

#### Q2: 内存不足
**现象**: 处理大量数据时内存不足  
**解决**: 减少回测时间范围或增加系统内存

#### Q3: 启动时间过长
**现象**: 首次运行需要很长时间  
**解决**: 首次需要生成缓存文件，后续运行会很快

### 结果分析问题

#### Q1: 收益率异常
**现象**: 收益率过高或过低  
**解决**: 检查配置文件设置，验证股票价格数据

#### Q2: 交易频率异常
**现象**: 交易过于频繁或稀少  
**解决**: 调整RSI阈值设置，检查信号参数

## 📈 性能优化建议

### 系统性能
1. **使用SSD硬盘**: 提高数据读写速度
2. **增加内存**: 减少数据交换，提升处理速度
3. **定期清理缓存**: 删除过期的缓存文件

### 回测效率
1. **合理设置回测期间**: 避免过长的回测时间
2. **利用数据缓存**: 避免重复数据获取
3. **批量处理**: 一次性处理多个股票

### 配置管理
1. **定期备份配置**: 备份重要的配置文件
2. **版本管理**: 对配置文件进行版本控制
3. **文档记录**: 记录配置变更和测试结果

## 💸 交易成本设置

系统模拟真实的A股交易成本：

- **买入手续费**: 0.03%
- **卖出手续费**: 0.03%  
- **印花税**: 0.1%（仅卖出）
- **滑点**: 0.1%

可在配置文件中调整这些参数以匹配实际券商费率。

## 📚 相关文档

- [技术说明文档](技术说明文档.md) - 详细的技术实现和架构说明
- [版本更新记录](版本更新记录.md) - 完整的版本历史和更新日志

## ⚠️ 风险提示

本系统仅用于策略回测和学术研究，不构成任何投资建议。实际投资请谨慎决策，投资有风险，入市需谨慎。

---

**文档维护**: 
- 创建时间: 2025年8月23日
- 维护频率: 随系统版本同步更新
- 负责团队: 开发团队
