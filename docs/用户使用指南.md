# 中线轮动策略系统用户使用指南

## 📋 文档概述

本文档是中线轮动策略系统的完整用户使用指南，整合了技术说明、报告使用说明等内容，为用户提供从安装配置到使用分析的全流程指导。

**版本信息**：
- 文档版本：v3.0（合并优化版）
- 系统版本：v2.2-CSV配置管理版
- 最后更新：2025年8月5日

## 🎯 系统简介

中线轮动策略系统是一个完整的股票轮动策略回测平台，支持4维信号分析、技术指标计算、交易成本模拟和详细的报告生成。

### 核心特性
- **4维信号分析**：趋势过滤器 + 超买超卖 + 动能确认 + 极端价格量能
- **渐进式买卖逻辑**：20%固定比例，风险控制优化
- **行业特定优化**：针对70+个申万二级行业的个性化规则
- **智能数据缓存**：避免重复获取，提升回测效率
- **详细交易记录**：包含28列完整技术指标的CSV导出
- **多格式报告**：HTML可视化报告 + 多个CSV分析文件
- **CSV配置管理**：灵活的配置文件系统

## 🚀 快速开始

### 系统要求

#### Python环境
```
Python 3.8+
内存: 建议4GB+
存储: 建议1GB+可用空间
```

#### 依赖包
```
pandas >= 1.3.0
numpy >= 1.21.0
akshare >= 1.8.0
pandas-ta >= 0.3.14b
matplotlib >= 3.5.0
plotly >= 5.0.0
```

### 安装步骤

1. **克隆项目**
```bash
git clone <项目地址>
cd Rotation_Strategy_3_1
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **验证安装**
```bash
python main.py --help
```

## ⚙️ 配置系统

系统使用CSV配置文件进行设置，灵活直观。

### CSV配置文件方式（推荐）

#### 1. 投资组合配置 (`Input/portfolio_config.csv`)

**文件格式**：
```csv
Stock_number,Stock_name,Initial_weight,Industry,DCF_value_per_share
601088,中国神华,0.0615,煤炭开采,40
601225,陕西煤业,0.0653,煤炭开采,40
600900,长江电力,0.0577,电力,35
CASH,现金,0.0093,,
```

**字段说明**：
- `Stock_number`: 股票代码（6位数字）或 CASH（现金）
- `Stock_name`: 股票名称或"现金"
- `Initial_weight`: 初始权重（小数形式，如0.0615表示6.15%）
- `Industry`: 行业分类（申万二级行业）
- `DCF_value_per_share`: DCF估值每股价值（可选）

**注意事项**：
- 文件必须使用UTF-8-BOM编码，确保Excel兼容
- 权重总和应接近1.0（允许±1%误差）
- 股票代码必须是6位数字格式

#### 2. 回测设置配置 (`Input/Becktest_settings.csv`)

**文件格式**：
```csv
Parameter,Value
total_capital,15000000
start_date,2021-01-08
end_date,2025-07-25
```

**支持参数**：
- `total_capital`: 总资金（整数）
- `start_date`: 开始日期（YYYY-MM-DD 或 YYYY/MM/DD）
- `end_date`: 结束日期（YYYY-MM-DD 或 YYYY/MM/DD）
- `rotation_percentage`: 轮动比例（可选，默认0.1）

#### 3. 行业RSI阈值配置 (`Input/industry_rsi_thresholds.csv`)

**文件格式**：
```csv
Industry,RSI_Overbought,RSI_Oversold,Divergence_Required,Strategy_Type
煤炭开采,75,25,是,保守型
食品制造,70,30,否,标准型
电力,75,35,否,极度保守型
```

**字段说明**：
- `Industry`: 行业名称（申万二级行业）
- `RSI_Overbought`: RSI超买阈值
- `RSI_Oversold`: RSI超卖阈值
- `Divergence_Required`: 是否需要背离确认（是/否）
- `Strategy_Type`: 策略类型（保守型/标准型/激进型等）

## 🏃‍♂️ 运行系统

### 基本运行

```bash
# 使用CSV配置文件运行
python main.py
```

### 运行示例

```bash
$ python main.py
🚀 开始运行中线轮动策略回测系统...

📊 配置信息:
- 配置类型: CSV配置
- 总资金: 15,000,000 元
- 回测期间: 2021-01-08 至 2025-07-25
- 股票数量: 16 只
- 现金权重: 0.93%

⏳ 正在获取数据...
✅ 数据获取完成

🔄 正在运行回测...
✅ 回测完成

📈 回测结果:
- 初始资金: 15,000,000 元
- 最终资产: 43,959,985 元
- 总收益率: 193.07%
- 年化收益率: 25.68%
- 最大回撤: -12.45%

📁 报告文件已生成:
- HTML报告: reports/integrated_backtest_report_20250805_124427.html
- 详细交易记录: reports/detailed_trading_records_20250805_124427.csv
```

## 📊 输出文件详解

系统会在 `reports/` 目录下生成多种格式的报告文件：

### 1. HTML可视化报告

**文件名格式**：`integrated_backtest_report_YYYYMMDD_HHMMSS.html`

**报告内容**：
- **基础回测指标**：收益率、年化收益率、最大回撤等
- **策略vs基准对比**：真实的基准对比分析
- **最终持仓状态**：回测结束时的详细持仓情况
- **交易统计指标**：交易次数、手续费统计
- **K线图交易点**：可视化买卖点标记，支持多股票切换
- **4维信号详情表**：完整的技术指标和信号状态分析
- **详细交易记录**：包含4维信号状态的完整交易表格
- **信号统计分析**：各股票的信号触发统计

### 2. 详细交易记录CSV

**文件名格式**：`detailed_trading_records_YYYYMMDD_HHMMSS.csv`

**包含28列完整信息**：

#### 基础交易信息（7列）
- 日期：交易日期
- 交易类型：BUY/SELL
- 股票代码：6位股票代码
- 交易股票数量：实际交易股数
- 交易后持仓数量：交易完成后的持仓
- 收盘价：当日收盘价
- 交易价格：实际成交价格

#### 技术指标快照（13列）
- 20周EMA：20周指数移动平均
- 14周RSI：相对强弱指数
- MACD_DIF：MACD差离值
- MACD_DEA：MACD信号线
- 布林带上轨/中轨/下轨：布林带指标
- 成交量：当周成交量
- 量能倍数：当周成交量/4周均量
- 布林带位置：上轨之上/轨道之间/下轨之下

#### 4维信号分析（5列）
- 趋势过滤器状态：✓/✗
- RSI信号状态：✓/✗
- MACD信号状态：✓/✗
- 布林带+量能状态：✓/✗
- 4维信号综合分析：满足维度数/总维度数 + 信号原因

#### 交易成本明细（3列）
- 交易金额：交易总金额
- 手续费：交易手续费
- 印花税：印花税费用
- 滑点成本：滑点损失
- 总交易成本：所有费用合计

#### 资产状态跟踪（5列）
- 交易后现金：交易完成后现金余额
- 交易后总资产：交易完成后总资产
- 累计收益率：从开始到当前的累计收益率
- 信号置信度：信号强度评分(0-100)
- 备注：额外说明信息

### 3. 基础交易记录CSV

**文件名格式**：`trading_records_YYYYMMDD_HHMMSS.csv`

**简化版交易记录**，包含基本交易信息，便于快速分析。

## 🔍 报告分析指南

### HTML报告使用

#### 1. 基础指标分析
- **总收益率**：策略整体表现
- **年化收益率**：年化投资回报
- **最大回撤**：最大亏损幅度
- **夏普比率**：风险调整后收益

#### 2. 基准对比分析
- **策略收益 vs 基准收益**：超额收益分析
- **风险收益对比**：风险调整后的表现对比
- **策略优势分析**：策略相对优势

#### 3. K线图交易分析
- **交易点标注**：直观查看买卖时机
- **技术指标叠加**：分析技术指标有效性
- **股票切换功能**：对比不同股票表现

#### 4. 信号统计分析
- **各维度触发频率**：了解信号分布
- **信号满足度分布**：分析信号质量
- **股票信号统计**：个股信号表现

### CSV文件分析

#### 1. 详细交易记录分析

**Excel分析步骤**：
1. 用Excel打开详细交易记录CSV文件
2. 使用数据透视表分析交易模式
3. 筛选特定条件的交易记录
4. 计算各种统计指标

**常用分析维度**：
- 按股票代码分组分析
- 按交易类型分组分析
- 按信号强度分组分析
- 按时间段分组分析

#### 2. 技术指标分析



## 🎯 策略核心逻辑：4维信号系统

系统的核心是一个4维信号过滤器，只有当**硬性条件（维度1）**满足，并且**其余3个维度中至少有2个**同时满足时，才会产生最终的买入或卖出信号。

*   **维度1：价值比过滤器 (硬性条件)**
    *   基于DCF（现金流折现）估值模型，判断当前股价是否处于低估或高估区域。
    *   **买入**: 价格/DCF估值 < 70%
    *   **卖出**: 价格/DCF估值 > 80%
    *   *注：若缺少DCF估值数据，系统会自动回退到使用20周EMA作为趋势过滤器。*

*   **维度2：超买超卖 (RSI + 背离 + 极端阈值)**
    *   **强制信号**: RSI触及个股所在行业的**极端阈值**时，无需背离确认，直接产生信号。
    *   **普通信号**: RSI进入常规超买/超卖区间（如70/30），并同时出现价格**背离**时，产生信号。

*   **维度3：动能确认 (MACD)**
    *   **买入**: MACD绿色柱体连续2根缩短，或MACD柱体已翻红，或DIF金叉DEA。
    *   **卖出**: MACD红色柱体连续2根缩短，或MACD柱体已翻绿，或DIF死叉DEA。

*   **维度4：极端价格+量能 (布林带 + 成交量)**
    *   **买入**: 收盘价 <= 布林带下轨，且成交量显著放大。
    *   **卖出**: 收盘价 >= 布林带上轨，且成交量显著放大。

### 渐进式买卖逻辑

#### 买入逻辑
- **无持仓时**：买入现金的20%
- **有持仓时**：买入当前持仓市值的20%
- **最小单位**：100股整数倍

#### 卖出逻辑
- **无持仓时**：忽略卖出信号
- **有持仓时**：卖出当前持仓市值的20%
- **最小单位**：100股整数倍

### 交易成本设置

- **买入手续费**：0.03%
- **卖出手续费**：0.03%
- **印花税**：0.1%（仅卖出）
- **滑点**：0.1%

## 🔧 高级功能

### 行业优化配置

系统支持针对不同行业设置个性化的RSI阈值和背离要求：

#### 行业分类（5个层级）
1. **极度保守型**（RSI 34-35/74-75）：电力、食品、银行
2. **保守型**（RSI 32-33/72-73）：医药、汽车服务
3. **标准型**（RSI 30-31/70-71）：房地产、化工
4. **激进型**（RSI 28-29/68-69）：有色金属、钢铁
5. **极度激进型**（RSI ≤27/≥67）：小金属、半导体

#### 背离要求配置
- **不要求背离**：稳定行业（公用事业、必需消费等）
- **要求背离**：周期性行业（有色金属、化工等）
- **极端免除**：达到极端阈值时可免除背离要求

### 数据缓存系统

#### 智能数据缓存
- **按股票+时间范围缓存**：避免重复获取
- **增量数据获取**：仅获取缺失数据
- **缓存合并**：新数据与现有缓存智能合并

#### 行业信息缓存
- **内存缓存**：单次回测内行业信息不重复获取
- **性能提升**：从数千次网络请求降低到每股票仅一次
- **缓存统计**：提供缓存命中率和性能提升统计

## 🚨 常见问题与解决方案

### 配置问题

#### Q1: CSV文件编码错误
**问题**：Excel打开CSV文件出现乱码
**解决**：
1. 确保CSV文件使用UTF-8-BOM编码
2. 使用记事本打开，另存为UTF-8-BOM格式
3. 或在Excel中使用"数据"->"从文本"导入

#### Q2: 权重总和不等于1.0
**问题**：系统提示权重总和验证失败
**解决**：
1. 检查所有权重值的小数位数
2. 确保权重总和在0.99-1.01之间
3. 调整权重值使总和接近1.0

#### Q3: 日期格式错误
**问题**：系统无法识别日期格式
**解决**：
1. 使用YYYY-MM-DD格式（如2021-01-08）
2. 或使用YYYY/MM/DD格式（如2021/01/08）
3. 避免使用其他日期格式

### 运行问题

#### Q1: 数据获取失败
**问题**：网络连接或数据源问题
**解决**：
1. 检查网络连接
2. 等待片刻后重试
3. 检查股票代码是否正确

#### Q2: 内存不足
**问题**：处理大量数据时内存不足
**解决**：
1. 减少回测时间范围
2. 减少股票数量
3. 增加系统内存

#### Q3: 回测时间过长
**问题**：回测运行时间过长
**解决**：
1. 检查数据缓存是否生效
2. 减少回测时间范围
3. 使用更快的硬盘（SSD）

### 结果分析问题

#### Q1: 收益率异常
**问题**：收益率过高或过低
**解决**：
1. 检查初始权重配置
2. 验证股票价格数据
3. 检查交易成本设置

#### Q2: 交易频率异常
**问题**：交易过于频繁或稀少
**解决**：
1. 调整信号参数
2. 检查行业RSI阈值设置
3. 验证技术指标计算

#### Q3: 报告文件打不开
**问题**：HTML或CSV文件无法打开
**解决**：
1. 检查文件路径和权限
2. 使用不同的浏览器打开HTML
3. 使用Excel或记事本打开CSV

## 📈 性能优化建议

### 系统性能
1. **使用SSD硬盘**：提高数据读写速度
2. **增加内存**：减少数据交换，提高处理速度
3. **定期清理缓存**：删除过期缓存文件

### 回测效率
1. **合理设置回测期间**：避免过长的回测时间
2. **利用数据缓存**：避免重复数据获取
3. **批量处理**：一次性处理多个股票

### 数据管理
1. **定期备份配置**：备份重要的配置文件
2. **版本管理**：对配置文件进行版本控制
3. **文档记录**：记录配置变更和测试结果

## 🔄 系统维护

### 定期维护任务

#### 每周维护
- 检查数据缓存大小
- 清理过期日志文件
- 更新股票池配置

#### 每月维护
- 优化数据缓存
- 检查系统性能
- 更新行业分类信息

#### 每季度维护
- 全面系统检查
- 配置文件备份
- 性能基准测试

### 故障排除

#### 日志分析
- 查看 `logs/` 目录下的日志文件
- 分析错误信息和警告
- 根据日志信息定位问题

#### 数据验证
- 验证股票数据完整性
- 检查技术指标计算结果
- 确认交易记录准确性

#### 配置检查
- 验证配置文件格式
- 检查参数设置合理性
- 确认权限和路径正确

## 📚 进阶使用

### 自定义配置

#### 创建新的股票池
1. 复制现有的投资组合配置文件
2. 修改股票代码和权重
3. 调整行业分类和DCF估值
4. 验证配置文件格式

#### 调整策略参数
1. 修改RSI阈值设置
2. 调整MACD参数
3. 改变布林带参数
4. 测试参数效果

#### 优化交易成本
1. 根据实际券商费率调整
2. 考虑不同市场的成本差异
3. 包含其他交易成本

### 批量测试

#### 参数敏感性分析
1. 创建多个配置文件
2. 批量运行回测
3. 对比不同参数的效果
4. 选择最优参数组合

#### 时间窗口分析
1. 设置不同的回测时间段
2. 分析策略在不同市场环境下的表现
3. 识别策略的适用条件

#### 股票池对比
1. 测试不同的股票组合
2. 分析行业配置的影响
3. 优化股票池构成

## 📞 技术支持

### 获取帮助

#### 文档资源
- 《系统架构设计文档》：技术架构和API接口
- 《渐进式买卖逻辑设计文档》：核心算法详解
- 《行业优化更新总结》：行业特定优化说明
- 《项目状态记录》：项目开发进度和更新历史

#### 在线支持
- 项目GitHub Issues：报告问题和建议
- 技术交流群：与其他用户交流经验
- 邮件支持：发送详细问题描述

#### 问题反馈
提交问题时请包含：
1. 系统版本信息
2. 详细的错误信息
3. 复现步骤
4. 相关配置文件
5. 日志文件片段

---

**文档维护**：
- 创建时间：2025年8月5日
- 文档版本：v3.0（合并优化版）
- 维护责任：开发团队
- 更新频率：随系统版本同步更新

**相关文档**：
- 《系统架构设计文档》：技术架构和开发参考
- 《增强版回测系统完整文档》：详细功能说明
- 《渐进式买卖逻辑设计文档》：核心算法设计
- 《行业优化更新总结》：行业优化功能说明
- 《项目状态记录》：项目开发状态和历史