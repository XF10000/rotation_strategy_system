# ä¸­çº¿è¡Œä¸šè½®åŠ¨ç­–ç•¥æŠ€æœ¯è¯´æ˜æ–‡æ¡£

**ç‰ˆæœ¬**: 4.1  
**æ—¥æœŸ**: 2025-08-22  
**æ›´æ–°å†…å®¹**: æ–°å¢å­£åº¦è‡ªåŠ¨æ›´æ–°æœºåˆ¶æŠ€æœ¯å®ç°

## 1. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1.1 æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é…ç½®ç®¡ç†å±‚     â”‚    â”‚   æ•°æ®å¤„ç†å±‚     â”‚    â”‚   ç­–ç•¥æ‰§è¡Œå±‚     â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚ â€¢ CSVé…ç½®åŠ è½½   â”‚    â”‚ â€¢ æ•°æ®è·å–      â”‚    â”‚ â€¢ ä¿¡å·ç”Ÿæˆå™¨     â”‚
â”‚ â€¢ å‚æ•°ç®¡ç†      â”‚    â”‚ â€¢ æ•°æ®ç¼“å­˜      â”‚    â”‚ â€¢ åŠ¨æ€ä»“ä½ç®¡ç†   â”‚
â”‚ â€¢ é˜ˆå€¼è®¡ç®—      â”‚    â”‚ â€¢ æ•°æ®é¢„å¤„ç†    â”‚    â”‚ â€¢ å›æµ‹å¼•æ“      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   åˆ†ææŠ¥å‘Šå±‚     â”‚
                    â”‚                â”‚
                    â”‚ â€¢ æ€§èƒ½åˆ†æ      â”‚
                    â”‚ â€¢ æŠ¥å‘Šç”Ÿæˆ      â”‚
                    â”‚ â€¢ å¯è§†åŒ–å±•ç¤º    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒæ¨¡å—å…³ç³»
- **é…ç½®ç®¡ç†**: ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç­–ç•¥å‚æ•°å’Œé˜ˆå€¼
- **æ•°æ®å¤„ç†**: è´Ÿè´£æ•°æ®è·å–ã€ç¼“å­˜å’Œé¢„å¤„ç†
- **ç­–ç•¥æ‰§è¡Œ**: æ ¸å¿ƒäº¤æ˜“é€»è¾‘å’Œä»“ä½ç®¡ç†
- **åˆ†ææŠ¥å‘Š**: å›æµ‹ç»“æœåˆ†æå’Œå¯è§†åŒ–

## 2. æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶

### 2.1 ä¿¡å·ç”Ÿæˆå™¨ (SignalGenerator)

#### 2.1.1 4ç»´ä¿¡å·ç³»ç»Ÿå®ç°
```python
class SignalGenerator:
    def generate_signal(self, stock_code, date, data):
        """
        4ç»´ä¿¡å·ç”Ÿæˆé€»è¾‘:
        1. ä»·å€¼è¿‡æ»¤å™¨ (ç¡¬æ€§æ¡ä»¶)
        2. RSIè¶…ä¹°è¶…å– (åŠ¨æ€é˜ˆå€¼)
        3. MACDåŠ¨èƒ½ç¡®è®¤
        4. å¸ƒæ—å¸¦+æˆäº¤é‡æç«¯ä¿¡å·
        
        è¿”å›: (signal_type, signal_strength, dimensions_status)
        """
```

#### 2.1.2 åŠ¨æ€RSIé˜ˆå€¼ç³»ç»Ÿ
- **æ•°æ®é©±åŠ¨**: åŸºäºå†å²RSIåˆ†å¸ƒçš„åˆ†ä½æ•°è®¡ç®—
- **è¡Œä¸šå·®å¼‚åŒ–**: 124ä¸ªç”³ä¸‡äºŒçº§è¡Œä¸šå„è‡ªç‹¬ç«‹é˜ˆå€¼
- **è‡ªé€‚åº”æ›´æ–°**: å®šæœŸé‡æ–°è®¡ç®—é˜ˆå€¼ä»¥é€‚åº”å¸‚åœºå˜åŒ–

```python
# RSIé˜ˆå€¼è®¡ç®—ç¤ºä¾‹
def calculate_dynamic_rsi_thresholds(industry_data):
    """
    åŸºäºå†å²RSIåˆ†å¸ƒè®¡ç®—åŠ¨æ€é˜ˆå€¼
    - æ™®é€šé˜ˆå€¼: 20%/80% åˆ†ä½æ•°
    - æç«¯é˜ˆå€¼: 10%/90% åˆ†ä½æ•°
    """
    return {
        'oversold_normal': np.percentile(rsi_values, 20),
        'oversold_extreme': np.percentile(rsi_values, 10),
        'overbought_normal': np.percentile(rsi_values, 80),
        'overbought_extreme': np.percentile(rsi_values, 90)
    }
```

### 2.2 ğŸ†• åŠ¨æ€ä»“ä½ç®¡ç†å™¨ (DynamicPositionManager)

#### 2.2.1 æ ¸å¿ƒè®¾è®¡ç†å¿µ
- **ä¼°å€¼é©±åŠ¨**: åŸºäºä»·å€¼æ¯”(`å½“å‰ä»·æ ¼/DCFä¼°å€¼`)åŠ¨æ€è°ƒæ•´ä»“ä½
- **é£é™©å¯æ§**: é€šè¿‡ä»“ä½ä¸Šé™å’Œç°é‡‘å®‰å…¨å«æ§åˆ¶é£é™©
- **èµ„é‡‘æ•ˆç‡**: æ ¹æ®æœºä¼šè´¨é‡æ™ºèƒ½é…ç½®èµ„é‡‘

#### 2.2.2 æŠ€æœ¯å®ç°
```python
class DynamicPositionManager:
    def __init__(self, config):
        self.value_ratio_thresholds = {
            'extreme_undervalued': 0.60,
            'significantly_undervalued': 0.70,
            'slightly_undervalued': 0.80,
            'fairly_valued': 1.00,
            'slightly_overvalued': 1.20
        }
        
    def calculate_position_size(self, signal_type, stock_code, 
                              current_price, dcf_value, 
                              current_position, available_cash, 
                              total_assets):
        """
        åŠ¨æ€ä»“ä½è®¡ç®—æ ¸å¿ƒé€»è¾‘
        """
        value_ratio = current_price / dcf_value if dcf_value else None
        
        if signal_type == 'BUY':
            return self._calculate_buy_position(
                value_ratio, current_position, 
                available_cash, total_assets
            )
        elif signal_type == 'SELL':
            return self._calculate_sell_position(
                value_ratio, current_position
            )
```

#### 2.2.3 ä¹°å…¥ä»“ä½ç­–ç•¥
```python
def _calculate_buy_position(self, value_ratio, current_position, 
                           available_cash, total_assets):
    """
    åŸºäºä¼°å€¼æ°´å¹³å’Œç°é‡‘æƒ…å†µçš„ä¹°å…¥ä»“ä½è®¡ç®—ï¼Œä¸¥æ ¼æ§åˆ¶å•åªè‚¡ç¥¨æ€»ä»“ä½é£é™©
    """
    # ç¬¬ä¸€æ­¥ï¼šåŸºäºä¼°å€¼æ°´å¹³ç¡®å®šåŸºç¡€ä¹°å…¥é‡‘é¢
    if value_ratio <= 0.60:  # æåº¦ä½ä¼°
        if current_position > 0:
            # æœ‰æŒä»“ï¼šç°é‡‘å……è¶³æ€§æ£€æŸ¥
            required_cash = current_position * 0.50  # 50%å½“å‰æŒä»“ä»·å€¼
            if available_cash >= required_cash:
                base_amount = required_cash
            else:
                base_amount = available_cash * 0.80  # 80%ç°é‡‘
        else:
            # æ— æŒä»“ï¼šç°é‡‘å……è¶³æ€§æ£€æŸ¥
            target_amount = total_assets * 0.15  # 15%æ€»èµ„äº§
            if available_cash >= target_amount:
                base_amount = target_amount
            else:
                base_amount = available_cash * 0.80  # 80%ç°é‡‘
        single_trade_limit = total_assets * 0.15
        
    elif value_ratio <= 0.70:  # æ˜æ˜¾ä½ä¼°
        if current_position > 0:
            required_cash = current_position * 0.20  # 20%å½“å‰æŒä»“ä»·å€¼
            if available_cash >= required_cash:
                base_amount = required_cash
            else:
                base_amount = available_cash * 0.80  # 80%ç°é‡‘
        else:
            target_amount = total_assets * 0.10  # 10%æ€»èµ„äº§
            if available_cash >= target_amount:
                base_amount = target_amount
            else:
                base_amount = available_cash * 0.80  # 80%ç°é‡‘
        single_trade_limit = total_assets * 0.10
        
    elif value_ratio <= 0.80:  # è½»åº¦ä½ä¼°
        if current_position > 0:
            required_cash = current_position * 0.10  # 10%å½“å‰æŒä»“ä»·å€¼
            if available_cash >= required_cash:
                base_amount = required_cash
            else:
                base_amount = available_cash * 0.80  # 80%ç°é‡‘
        else:
            target_amount = total_assets * 0.05  # 5%æ€»èµ„äº§
            if available_cash >= target_amount:
                base_amount = target_amount
            else:
                base_amount = available_cash * 0.80  # 80%ç°é‡‘
        single_trade_limit = total_assets * 0.05
    
    # åº”ç”¨å•ç¬”äº¤æ˜“é™åˆ¶
    base_amount = min(base_amount, single_trade_limit)
    
    # ç¬¬äºŒæ­¥ï¼šåº”ç”¨æ€»ä»“ä½é™åˆ¶ï¼ˆç¡¬æ€§çº¦æŸï¼‰
    max_total_position = total_assets * 0.20  # å•è‚¡æ€»ä»“ä½ä¸Šé™20%
    current_position_value = current_position  # å½“å‰æŒä»“ä»·å€¼
    
    # è®¡ç®—å‰©ä½™å¯ä¹°å…¥ç©ºé—´
    remaining_capacity = max_total_position - current_position_value
    
    # å¦‚æœå½“å‰æŒä»“å·²è¾¾åˆ°æˆ–è¶…è¿‡20%ï¼Œåˆ™ä¸æ‰§è¡Œä¹°å…¥
    if remaining_capacity <= 0:
        return 0
    
    # æœ€ç»ˆä¹°å…¥é‡‘é¢ = min(åŸºç¡€ä¹°å…¥é‡‘é¢, å‰©ä½™å¯ä¹°å…¥ç©ºé—´)
    final_amount = min(base_amount, remaining_capacity)
    
    return max(0, final_amount)
```

#### 2.2.4 å–å‡ºä»“ä½ç­–ç•¥
```python
def _calculate_sell_position(self, value_ratio, current_position):
    """
    åŸºäºä¼°å€¼æ°´å¹³çš„å–å‡ºä»“ä½è®¡ç®—
    """
    if value_ratio > 1.20:  # æåº¦é«˜ä¼°
        return current_position * 1.00  # å…¨éƒ¨å–å‡º
    elif value_ratio > 1.00:  # è½»åº¦é«˜ä¼°
        return current_position * 0.80  # å‡ä»“80%
    elif value_ratio > 0.80:  # åˆç†åŒºé—´
        return current_position * 0.50  # å‡ä»“50%
    elif value_ratio > 0.70:  # è½»åº¦ä½ä¼°
        return current_position * 0.20  # å‡ä»“20%
    
    return 0  # å…¶ä»–æƒ…å†µä¸å–å‡º
```

### 2.3 ğŸ†• å­£åº¦è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ

#### 2.3.1 è¡Œä¸šæ˜ å°„è‡ªåŠ¨æ›´æ–°å™¨ (IndustryMappingUpdater)

```python
class IndustryMappingUpdater:
    def __init__(self, mapping_file_path='utils/stock_to_industry_map.json'):
        self.mapping_file_path = mapping_file_path
        self.min_stock_count = 5000  # æœ€å°è‚¡ç¥¨æ•°é‡é˜ˆå€¼
        self.max_age_months = 4      # æ–‡ä»¶æœ€å¤§å¹´é¾„ï¼ˆæœˆï¼‰
    
    def needs_update(self):
        """
        æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°è¡Œä¸šæ˜ å°„æ–‡ä»¶
        æ£€æŸ¥æ¡ä»¶ï¼š
        1. æ–‡ä»¶ä¸å­˜åœ¨
        2. è·¨å­£åº¦æ›´æ–°
        3. æ–‡ä»¶è¿‡æœŸï¼ˆè¶…è¿‡4ä¸ªæœˆï¼‰
        4. è‚¡ç¥¨æ•°é‡å¼‚å¸¸
        """
        if not os.path.exists(self.mapping_file_path):
            return True, "æ–‡ä»¶ä¸å­˜åœ¨"
        
        # æ£€æŸ¥å­£åº¦å˜åŒ–
        file_time = datetime.fromtimestamp(os.path.getmtime(self.mapping_file_path))
        current_time = datetime.now()
        
        if self._is_quarter_changed(file_time, current_time):
            return True, "è·¨å­£åº¦æ›´æ–°"
        
        # æ£€æŸ¥æ–‡ä»¶å¹´é¾„
        if self._is_file_expired(file_time, current_time):
            return True, "æ–‡ä»¶è¿‡æœŸ"
        
        # æ£€æŸ¥æ•°æ®è´¨é‡
        if not self._validate_stock_count():
            return True, "è‚¡ç¥¨æ•°é‡å¼‚å¸¸"
        
        return False, "æ— éœ€æ›´æ–°"
```

#### 2.3.2 RSIé˜ˆå€¼è‡ªåŠ¨æ›´æ–°å™¨ (RSIThresholdUpdater)

```python
class RSIThresholdUpdater:
    def __init__(self, threshold_file_path='sw_rsi_thresholds/output/sw2_rsi_threshold.csv'):
        self.threshold_file_path = threshold_file_path
        self.expected_industry_count = 124  # ç”³ä¸‡äºŒçº§è¡Œä¸šæ•°é‡
        self.max_age_months = 4
    
    def update_if_needed(self):
        """
        æ™ºèƒ½æ›´æ–°RSIé˜ˆå€¼æ–‡ä»¶
        """
        needs_update, reason = self.needs_update()
        
        if needs_update:
            print(f"æ£€æµ‹åˆ°éœ€è¦æ›´æ–°RSIé˜ˆå€¼æ–‡ä»¶: {reason}")
            return self._run_rsi_calculation()
        else:
            print("RSIé˜ˆå€¼æ–‡ä»¶æ— éœ€æ›´æ–°")
            return True
    
    def _run_rsi_calculation(self):
        """
        æ‰§è¡ŒRSIé˜ˆå€¼è®¡ç®—è„šæœ¬
        """
        script_path = 'sw_rsi_thresholds/run_sw_2021_rsi_calculation.py'
        
        try:
            result = subprocess.run(
                [sys.executable, script_path],
                capture_output=True,
                text=True,
                cwd=os.path.dirname(os.path.abspath(__file__))
            )
            
            if result.returncode == 0:
                print("RSIé˜ˆå€¼è®¡ç®—å®Œæˆ")
                return True
            else:
                print(f"RSIé˜ˆå€¼è®¡ç®—å¤±è´¥: {result.stderr}")
                return False
                
        except Exception as e:
            print(f"æ‰§è¡ŒRSIé˜ˆå€¼è®¡ç®—æ—¶å‡ºé”™: {str(e)}")
            return False
```

#### 2.3.3 ä¸»ç¨‹åºé›†æˆ

```python
# main.py ä¸­çš„é›†æˆç¤ºä¾‹
def ensure_data_freshness():
    """
    ç¡®ä¿æ•°æ®æ–‡ä»¶çš„æ–°é²œåº¦
    åœ¨å›æµ‹å¼€å§‹å‰è‡ªåŠ¨æ£€æŸ¥å’Œæ›´æ–°å¿…è¦çš„æ•°æ®æ–‡ä»¶
    """
    print("\n=== æ•°æ®æ–‡ä»¶æ£€æŸ¥ä¸æ›´æ–° ===")
    
    # 1. æ£€æŸ¥è¡Œä¸šæ˜ å°„æ–‡ä»¶
    industry_updater = IndustryMappingUpdater()
    industry_updater.update_if_needed()
    
    # 2. æ£€æŸ¥RSIé˜ˆå€¼æ–‡ä»¶
    rsi_updater = RSIThresholdUpdater()
    rsi_updater.update_if_needed()
    
    print("æ•°æ®æ–‡ä»¶æ£€æŸ¥å®Œæˆ\n")

def main():
    # å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥æ•°æ®æ–‡ä»¶
    ensure_data_freshness()
    
    # ç»§ç»­æ­£å¸¸çš„å›æµ‹æµç¨‹
    # ...
```

### 2.4 å›æµ‹å¼•æ“ (BacktestEngine)

#### 2.3.1 æ ¸å¿ƒæµç¨‹
```python
class BacktestEngine:
    def run_backtest(self):
        """
        å›æµ‹ä¸»æµç¨‹:
        1. æ•°æ®åŠ è½½å’Œé¢„å¤„ç†
        2. é€æ—¥éå†å†å²æ•°æ®
        3. ä¿¡å·ç”Ÿæˆå’Œä»“ä½è®¡ç®—
        4. äº¤æ˜“æ‰§è¡Œå’Œç»„åˆæ›´æ–°
        5. æ€§èƒ½åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆ
        """
        for date in self.date_range:
            # è·å–å½“æ—¥æ•°æ®
            daily_data = self.get_daily_data(date)
            
            # ç”Ÿæˆäº¤æ˜“ä¿¡å·
            signals = self.signal_generator.generate_signals(daily_data)
            
            # åŠ¨æ€ä»“ä½ç®¡ç†
            for signal in signals:
                position_size = self.position_manager.calculate_position_size(
                    signal, self.portfolio.get_current_position(signal.stock_code)
                )
                
                # æ‰§è¡Œäº¤æ˜“
                self.portfolio.execute_trade(signal, position_size)
            
            # æ›´æ–°ç»„åˆä»·å€¼
            self.portfolio.update_portfolio_value(date, daily_data)
```

#### 2.3.2 æ•°æ®ç¼“å­˜æœºåˆ¶
- **æ™ºèƒ½ç¼“å­˜**: è‡ªåŠ¨æ£€æµ‹æ•°æ®æ›´æ–°ï¼Œé¿å…é‡å¤ä¸‹è½½
- **å¢é‡æ›´æ–°**: åªä¸‹è½½ç¼ºå¤±çš„æ•°æ®ï¼Œæé«˜æ•ˆç‡
- **å¤šæºèåˆ**: æ•´åˆå¤šä¸ªæ•°æ®æºï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§

### 2.5 æ€§èƒ½åˆ†æå™¨ (PerformanceAnalyzer)

#### 2.4.1 å…³é”®æŒ‡æ ‡è®¡ç®—
```python
class PerformanceAnalyzer:
    def calculate_metrics(self, portfolio_values, benchmark_values):
        """
        è®¡ç®—å…³é”®æ€§èƒ½æŒ‡æ ‡:
        - æ€»æ”¶ç›Šç‡ã€å¹´åŒ–æ”¶ç›Šç‡
        - å¤æ™®æ¯”ç‡ã€ç´¢æè¯ºæ¯”ç‡
        - æœ€å¤§å›æ’¤ã€èƒœç‡
        - åŸºå‡†è¶…é¢æ”¶ç›Š
        """
        return {
            'total_return': self._calculate_total_return(portfolio_values),
            'annual_return': self._calculate_annual_return(portfolio_values),
            'sharpe_ratio': self._calculate_sharpe_ratio(portfolio_values),
            'max_drawdown': self._calculate_max_drawdown(portfolio_values),
            'win_rate': self._calculate_win_rate(self.trades),
            'alpha': self._calculate_alpha(portfolio_values, benchmark_values)
        }
```

## 3. ğŸ†• è‡ªåŠ¨æ›´æ–°æœºåˆ¶è®¾è®¡

### 3.1 æ›´æ–°è§¦å‘æ¡ä»¶

#### 3.1.1 å­£åº¦æ£€æŸ¥é€»è¾‘
```python
def _is_quarter_changed(self, file_time, current_time):
    """
    æ£€æŸ¥æ˜¯å¦è·¨å­£åº¦
    """
    file_quarter = (file_time.month - 1) // 3 + 1
    current_quarter = (current_time.month - 1) // 3 + 1
    
    return (file_quarter != current_quarter) or (file_time.year != current_time.year)
```

#### 3.1.2 æ–‡ä»¶è¿‡æœŸæ£€æŸ¥
```python
def _is_file_expired(self, file_time, current_time):
    """
    æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿‡æœŸï¼ˆè¶…è¿‡4ä¸ªæœˆï¼‰
    """
    age_months = (current_time.year - file_time.year) * 12 + (current_time.month - file_time.month)
    return age_months >= self.max_age_months
```

#### 3.1.3 æ•°æ®è´¨é‡éªŒè¯
```python
def _validate_stock_count(self):
    """
    éªŒè¯è‚¡ç¥¨æ•°é‡æ˜¯å¦æ­£å¸¸
    """
    try:
        with open(self.mapping_file_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
            stock_count = len(data.get('mapping', {}))
            return stock_count >= self.min_stock_count
    except:
        return False
```

### 3.2 æ›´æ–°æ‰§è¡Œç­–ç•¥

#### 3.2.1 è¡Œä¸šæ˜ å°„æ›´æ–°æµç¨‹
1. **æ•°æ®è·å–**: é€šè¿‡akshare APIè·å–æœ€æ–°ç”³ä¸‡è¡Œä¸šåˆ†ç±»
2. **æˆåˆ†è‚¡è·å–**: è·å–å„è¡Œä¸šçš„æˆåˆ†è‚¡åˆ—è¡¨
3. **æ˜ å°„æ„å»º**: æ„å»ºè‚¡ç¥¨ä»£ç åˆ°è¡Œä¸šçš„æ˜ å°„å…³ç³»
4. **æ–‡ä»¶ä¿å­˜**: ä¿å­˜ä¸ºJSONæ ¼å¼åˆ°`utils/`ç›®å½•
5. **éªŒè¯æ£€æŸ¥**: éªŒè¯ç”Ÿæˆæ–‡ä»¶çš„å®Œæ•´æ€§

#### 3.2.2 RSIé˜ˆå€¼æ›´æ–°æµç¨‹
1. **å†å²æ•°æ®è·å–**: è·å–124ä¸ªç”³ä¸‡äºŒçº§è¡Œä¸š104å‘¨å†å²æ•°æ®
2. **RSIè®¡ç®—**: è®¡ç®—å„è¡Œä¸šçš„14å‘¨RSIæŒ‡æ ‡
3. **æ³¢åŠ¨ç‡åˆ†å±‚**: æ ¹æ®RSIæ ‡å‡†å·®è¿›è¡Œé«˜ä¸­ä½æ³¢åŠ¨åˆ†å±‚
4. **é˜ˆå€¼è®¡ç®—**: è®¡ç®—å„å±‚çº§çš„åŠ¨æ€è¶…ä¹°è¶…å–é˜ˆå€¼
5. **ç»“æœä¿å­˜**: ä¿å­˜ä¸ºCSVæ ¼å¼åˆ°`sw_rsi_thresholds/output/`ç›®å½•

### 3.3 é”™è¯¯å¤„ç†ä¸å®¹é”™

```python
class UpdateErrorHandler:
    def __init__(self, max_retries=3):
        self.max_retries = max_retries
    
    def safe_update(self, update_func, fallback_func=None):
        """
        å®‰å…¨æ›´æ–°æœºåˆ¶ï¼ŒåŒ…å«é‡è¯•å’Œé™çº§ç­–ç•¥
        """
        for attempt in range(self.max_retries):
            try:
                return update_func()
            except Exception as e:
                print(f"æ›´æ–°å°è¯• {attempt + 1} å¤±è´¥: {str(e)}")
                if attempt == self.max_retries - 1:
                    if fallback_func:
                        print("æ‰§è¡Œé™çº§ç­–ç•¥")
                        return fallback_func()
                    else:
                        print("æ›´æ–°å¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰æ–‡ä»¶")
                        return False
                time.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿
        return False
```

## 4. æ•°æ®å¤„ç†ä¸å­˜å‚¨

### 3.1 æ•°æ®æºç®¡ç†
- **ä¸»æ•°æ®æº**: akshare (å…è´¹ã€ç¨³å®š)
- **å¤‡ç”¨æ•°æ®æº**: tushare, æ–°æµªè´¢ç»
- **æ•°æ®ç±»å‹**: è‚¡ä»·ã€æˆäº¤é‡ã€è´¢åŠ¡æ•°æ®ã€è¡Œä¸šåˆ†ç±»

### 3.2 æ•°æ®ç¼“å­˜ç­–ç•¥
```python
class DataCache:
    def __init__(self, cache_dir='data_cache'):
        self.cache_dir = cache_dir
        self.cache_expiry = 24 * 3600  # 24å°æ—¶è¿‡æœŸ
    
    def get_cached_data(self, key):
        """è·å–ç¼“å­˜æ•°æ®ï¼Œè‡ªåŠ¨æ£€æŸ¥è¿‡æœŸæ—¶é—´"""
        cache_file = os.path.join(self.cache_dir, f"{key}.pkl")
        if os.path.exists(cache_file):
            mtime = os.path.getmtime(cache_file)
            if time.time() - mtime < self.cache_expiry:
                return pickle.load(open(cache_file, 'rb'))
        return None
```

### 4.3 ğŸ†• è¡Œä¸šåˆ†ç±»æ˜ å°„è‡ªåŠ¨åŒ–
- **ç”³ä¸‡äºŒçº§è¡Œä¸š**: 124ä¸ªç»†åˆ†è¡Œä¸šï¼Œ5,209åªè‚¡ç¥¨
- **å­£åº¦è‡ªåŠ¨æ›´æ–°**: æ¯å­£åº¦è‡ªåŠ¨æ£€æŸ¥å¹¶æ›´æ–°è¡Œä¸šæ˜ å°„
- **æœ¬åœ°ç¼“å­˜ä¼˜åŒ–**: é¿å…é¢‘ç¹ç½‘ç»œæŸ¥è¯¢ï¼Œæå‡æ€§èƒ½
- **æ™ºèƒ½åŒ¹é…**: åŸºäºè‚¡ç¥¨ä»£ç å’Œåç§°çš„æ™ºèƒ½åŒ¹é…ç®—æ³•
- **æ•°æ®éªŒè¯**: è‡ªåŠ¨éªŒè¯æ•°æ®å®Œæ•´æ€§å’Œå‡†ç¡®æ€§

## 5. é…ç½®ç®¡ç†ç³»ç»Ÿ

### 4.1 CSVé…ç½®æ–‡ä»¶
- **å›æµ‹è®¾ç½®** (`Becktest_settings.csv`): å›æµ‹æ—¶é—´èŒƒå›´ã€åˆå§‹èµ„é‡‘ç­‰
- **ç»„åˆé…ç½®** (`portfolio_config.csv`): è‚¡ç¥¨æ± å’Œæƒé‡é…ç½®
- **RSIé˜ˆå€¼** (`industry_rsi_thresholds.csv`): å„è¡Œä¸šåŠ¨æ€RSIé˜ˆå€¼

### 4.2 é…ç½®åŠ è½½å™¨
```python
class CSVConfigLoader:
    def load_backtest_config(self):
        """åŠ è½½å›æµ‹é…ç½®"""
        config = pd.read_csv('Input/Becktest_settings.csv')
        return {
            'start_date': config['start_date'].iloc[0],
            'end_date': config['end_date'].iloc[0],
            'initial_capital': float(config['initial_capital'].iloc[0])
        }
```

## 6. æŠ¥å‘Šç”Ÿæˆç³»ç»Ÿ

### 5.1 HTMLæŠ¥å‘Š
- **äº¤äº’å¼å›¾è¡¨**: ä½¿ç”¨Plotlyç”ŸæˆåŠ¨æ€å›¾è¡¨
- **Kçº¿å›¾æ ‡æ³¨**: æ ‡è®°ä¹°å–ç‚¹å’ŒæŠ€æœ¯æŒ‡æ ‡
- **å¤šç»´åº¦åˆ†æ**: 4ä¸ªä¿¡å·ç»´åº¦çš„è¯¦ç»†çŠ¶æ€å±•ç¤º

### 5.2 CSVè¯¦ç»†æŠ¥å‘Š
- **äº¤æ˜“æ˜ç»†**: æ¯ç¬”äº¤æ˜“çš„å®Œæ•´è®°å½•
- **ä¿¡å·çŠ¶æ€**: è§¦å‘äº¤æ˜“æ—¶4ä¸ªç»´åº¦çš„è¯¦ç»†çŠ¶æ€
- **ğŸ†• ä»“ä½å†³ç­–**: åŠ¨æ€ä»“ä½ç®¡ç†çš„å†³ç­–ä¾æ®
- **ğŸ†• ä¼°å€¼åˆ†æ**: ä»·å€¼æ¯”å’ŒDCFä¼°å€¼æ•°æ®

### 5.3 æŠ¥å‘Šæ¨¡æ¿
```html
<!-- HTMLæŠ¥å‘Šæ¨¡æ¿ç¤ºä¾‹ -->
<div class="signal-analysis">
    <h3>4ç»´ä¿¡å·åˆ†æ</h3>
    <div class="dimension">
        <span class="label">ä»·å€¼è¿‡æ»¤å™¨:</span>
        <span class="status {{value_filter_status}}">{{value_ratio}}</span>
    </div>
    <div class="dimension">
        <span class="label">RSIä¿¡å·:</span>
        <span class="status {{rsi_status}}">{{rsi_value}}</span>
    </div>
    <!-- å…¶ä»–ç»´åº¦... -->
</div>
```

## 7. ğŸ†• åŠ¨æ€ä»“ä½ç®¡ç†æŠ€æœ¯ç»†èŠ‚

### 6.1 é£é™©æ§åˆ¶æœºåˆ¶
```python
class RiskController:
    def __init__(self):
        self.max_single_position = 0.20  # å•è‚¡æ€»ä»“ä½ä¸Šé™20%ï¼ˆæ ¸å¿ƒçº¦æŸï¼‰
        self.max_single_trade_ratios = {  # å•ç¬”äº¤æ˜“ä¸Šé™
            'extreme_undervalued': 0.15,  # æåº¦ä½ä¼°ï¼š15%æ€»èµ„äº§
            'significantly_undervalued': 0.10,  # æ˜æ˜¾ä½ä¼°ï¼š10%æ€»èµ„äº§
            'slightly_undervalued': 0.05   # è½»åº¦ä½ä¼°ï¼š5%æ€»èµ„äº§
        }
        self.min_cash_reserve = 0.05     # æœ€ä½5%ç°é‡‘
        self.min_trade_amount = 10000    # æœ€å°äº¤æ˜“é‡‘é¢
        
    def validate_trade(self, trade_amount, current_portfolio, stock_code):
        """äº¤æ˜“å‰é£é™©æ£€æŸ¥"""
        # æ£€æŸ¥ç°é‡‘å……è¶³æ€§
        if trade_amount > current_portfolio.available_cash:
            return False, "ç°é‡‘ä¸è¶³"
            
        # æ£€æŸ¥å•è‚¡æ€»ä»“ä½ä¸Šé™ï¼ˆæ ¸å¿ƒçº¦æŸï¼‰
        current_position_value = current_portfolio.get_position_value(stock_code)
        new_total_position_ratio = (current_position_value + trade_amount) / current_portfolio.total_value
        
        if new_total_position_ratio > self.max_single_position:
            return False, f"è¶…å‡ºå•è‚¡æ€»ä»“ä½ä¸Šé™20%ï¼Œå½“å‰å°†è¾¾åˆ°{new_total_position_ratio:.1%}"
            
        # æ£€æŸ¥ç°é‡‘å®‰å…¨å«
        remaining_cash = current_portfolio.available_cash - trade_amount
        if remaining_cash < current_portfolio.total_value * self.min_cash_reserve:
            return False, "è¿åç°é‡‘å®‰å…¨å«è¦æ±‚"
            
        return True, "é€šè¿‡é£é™©æ£€æŸ¥"
```

### 6.2 äº¤æ˜“æ‰§è¡Œä¼˜åŒ–
- **æœ€å°äº¤æ˜“å•ä½**: 100è‚¡æ•´æ•°å€ï¼Œç¬¦åˆAè‚¡äº¤æ˜“è§„åˆ™
- **æ»‘ç‚¹æ§åˆ¶**: è€ƒè™‘å¸‚åœºå†²å‡»æˆæœ¬
- **åˆ†æ‰¹æ‰§è¡Œ**: å¤§é¢äº¤æ˜“åˆ†æ‰¹æ‰§è¡Œï¼Œé™ä½å¸‚åœºå†²å‡»

### 6.3 ä¼°å€¼æ•°æ®å¤„ç†
```python
class ValuationProcessor:
    def get_dcf_value(self, stock_code, date):
        """è·å–DCFä¼°å€¼æ•°æ®"""
        # ä¼˜å…ˆä½¿ç”¨å®æ—¶DCFæ•°æ®
        dcf_value = self.dcf_data_source.get_value(stock_code, date)
        
        if dcf_value is None:
            # å›é€€åˆ°å†å²ä¼°å€¼æ•°æ®
            dcf_value = self.estimate_dcf_from_historical(stock_code, date)
            
        return dcf_value
    
    def calculate_value_ratio(self, current_price, dcf_value):
        """è®¡ç®—ä»·å€¼æ¯”ç‡"""
        if dcf_value and dcf_value > 0:
            return current_price / dcf_value
        return None
```

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 ğŸ†• å¯åŠ¨æ€§èƒ½ä¼˜åŒ–
- **æœ¬åœ°ç¼“å­˜**: è¡Œä¸šæ˜ å°„æ–‡ä»¶æœ¬åœ°ç¼“å­˜ï¼Œé¿å…ç½‘ç»œæŸ¥è¯¢
- **æ™ºèƒ½æ›´æ–°**: ä»…åœ¨å¿…è¦æ—¶æ›´æ–°ï¼Œé¿å…ä¸å¿…è¦çš„è®¡ç®—
- **å¹¶è¡Œå¤„ç†**: RSIé˜ˆå€¼è®¡ç®—æ”¯æŒå¹¶è¡Œå¤„ç†
- **å¢é‡æ›´æ–°**: æ”¯æŒå¢é‡æ•°æ®æ›´æ–°æœºåˆ¶

### 8.2 è®¡ç®—ä¼˜åŒ–

### 7.1 è®¡ç®—ä¼˜åŒ–
- **å‘é‡åŒ–è®¡ç®—**: ä½¿ç”¨numpyå’Œpandasçš„å‘é‡åŒ–æ“ä½œ
- **å¹¶è¡Œå¤„ç†**: å¤šè¿›ç¨‹å¤„ç†å¤§é‡è‚¡ç¥¨æ•°æ®
- **å†…å­˜ç®¡ç†**: åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„æ•°æ®ï¼Œæ§åˆ¶å†…å­˜ä½¿ç”¨

### 7.2 I/Oä¼˜åŒ–
- **æ‰¹é‡è¯»å†™**: å‡å°‘æ–‡ä»¶I/Oæ¬¡æ•°
- **å‹ç¼©å­˜å‚¨**: ä½¿ç”¨pickleå‹ç¼©å­˜å‚¨ç¼“å­˜æ•°æ®
- **å¼‚æ­¥åŠ è½½**: å¼‚æ­¥åŠ è½½éå…³é”®æ•°æ®

## 9. æµ‹è¯•ä¸éªŒè¯

### 8.1 å•å…ƒæµ‹è¯•
- **ä¿¡å·ç”Ÿæˆæµ‹è¯•**: éªŒè¯4ç»´ä¿¡å·é€»è¾‘æ­£ç¡®æ€§
- **ğŸ†• ä»“ä½ç®¡ç†æµ‹è¯•**: éªŒè¯åŠ¨æ€ä»“ä½è®¡ç®—å‡†ç¡®æ€§
- **æ•°æ®å¤„ç†æµ‹è¯•**: éªŒè¯æ•°æ®è·å–å’Œå¤„ç†é€»è¾‘

### 8.2 é›†æˆæµ‹è¯•
- **ç«¯åˆ°ç«¯å›æµ‹**: å®Œæ•´å›æµ‹æµç¨‹æµ‹è¯•
- **æ€§èƒ½åŸºå‡†æµ‹è¯•**: ä¸ä¹°å…¥æŒæœ‰ç­–ç•¥å¯¹æ¯”
- **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**: æç«¯å¸‚åœºæ¡ä»¶ä¸‹çš„ç³»ç»Ÿç¨³å®šæ€§

## 10. éƒ¨ç½²ä¸è¿ç»´

### 9.1 ç¯å¢ƒè¦æ±‚
```
Python >= 3.8
pandas >= 1.3.0
numpy >= 1.21.0
akshare >= 1.8.0
plotly >= 5.0.0
```

### 9.2 è¿è¡Œæ–¹å¼
```bash
# æ ‡å‡†å›æµ‹
python main.py

# è‡ªå®šä¹‰é…ç½®å›æµ‹
python main.py --config custom_config.csv

# æ‰¹é‡éªŒè¯
python batch_validate_portfolio.py
```

### 9.3 ç›‘æ§ä¸æ—¥å¿—
- **è¯¦ç»†æ—¥å¿—**: è®°å½•æ‰€æœ‰å…³é”®æ“ä½œå’Œå†³ç­–è¿‡ç¨‹
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ¢å¤æœºåˆ¶
- **æ€§èƒ½ç›‘æ§**: ç›‘æ§å›æµ‹æ‰§è¡Œæ—¶é—´å’Œèµ„æºä½¿ç”¨

## 11. ç‰ˆæœ¬æ›´æ–°è®°å½•

### V4.1 (2025-08-22) - å­£åº¦è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ
**æ–°å¢åŠŸèƒ½:**
- è¡Œä¸šæ˜ å°„æ–‡ä»¶å­£åº¦è‡ªåŠ¨æ›´æ–°æœºåˆ¶
- RSIåŠ¨æ€é˜ˆå€¼æ–‡ä»¶å­£åº¦è‡ªåŠ¨æ›´æ–°æœºåˆ¶
- æ™ºèƒ½æ›´æ–°è§¦å‘æ¡ä»¶ï¼ˆè·¨å­£åº¦ã€æ–‡ä»¶è¿‡æœŸã€æ•°æ®å¼‚å¸¸ï¼‰
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶

**æ€§èƒ½æå‡:**
- å¯åŠ¨é€Ÿåº¦å¤§å¹…ä¼˜åŒ–ï¼ˆä»æ•°åˆ†é’Ÿåˆ°ç§’çº§ï¼‰
- æœ¬åœ°ç¼“å­˜5,209åªè‚¡ç¥¨è¡Œä¸šæ˜ å°„
- é¿å…é¢‘ç¹ç½‘ç»œæŸ¥è¯¢ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§

**æŠ€æœ¯æ”¹è¿›:**
- æ–°å¢`IndustryMappingUpdater`å’Œ`RSIThresholdUpdater`æ¨¡å—
- é›†æˆåˆ°ä¸»ç¨‹åºå¯åŠ¨æµç¨‹
- å®Œå–„çš„æ•°æ®éªŒè¯å’Œè´¨é‡æ£€æŸ¥

### V4.0 (2025-08-11) - åŠ¨æ€ä»“ä½ç®¡ç†ç³»ç»Ÿ

### V4.0 (2025-08-11) - åŠ¨æ€ä»“ä½ç®¡ç†ç³»ç»Ÿ
**æ–°å¢åŠŸèƒ½:**
- åŸºäºä»·å€¼æ¯”çš„åŠ¨æ€ä»“ä½ç®¡ç†ç³»ç»Ÿ
- ä¼°å€¼é©±åŠ¨çš„ä¹°å–å†³ç­–é€»è¾‘
- å®Œå–„çš„é£é™©æ§åˆ¶æœºåˆ¶
- åˆ†çº¢é…è‚¡äº‹ä»¶å¤„ç†

**æŠ€æœ¯æ”¹è¿›:**
- é‡æ„ä»“ä½ç®¡ç†æ¨¡å—
- ä¼˜åŒ–äº¤æ˜“æ‰§è¡Œé€»è¾‘
- å¢å¼ºæŠ¥å‘Šç”ŸæˆåŠŸèƒ½
- å®Œå–„æµ‹è¯•è¦†ç›–

**æ€§èƒ½æå‡:**
- æé«˜èµ„é‡‘ä½¿ç”¨æ•ˆç‡
- é™ä½äº¤æ˜“é£é™©
- å¢å¼ºç­–ç•¥é€‚åº”æ€§

### V3.0 (2025-08-09) - å¤šç»´ä¿¡å·ç³»ç»Ÿ
- å®ç°4ç»´ä¿¡å·å†³ç­–æ¡†æ¶
- åŠ¨æ€RSIé˜ˆå€¼ç³»ç»Ÿ
- è¡Œä¸šå·®å¼‚åŒ–å¤„ç†

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æŠ€æœ¯æ–‡æ¡£å°†éšç€ç³»ç»ŸåŠŸèƒ½è¿­ä»£æŒç»­æ›´æ–°ï¼Œç¡®ä¿æŠ€æœ¯å®ç°ä¸éœ€æ±‚ä¿æŒä¸€è‡´ã€‚