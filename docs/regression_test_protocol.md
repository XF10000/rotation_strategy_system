# 回归测试标准流程

## 📋 目的

确保每个优化阶段完成后，系统功能与优化前**100%一致**，回测结果数值误差**<0.01%**。

---

## 🔧 测试配置

### 固定测试配置文件
- **文件**: `Input/Backtest_settings_regression_test.csv`
- **用途**: 专门用于回归测试，**禁止修改**
- **时间段**: 2024-01-12 到 2025-12-30（718天）
- **总资本**: 100,000,000元

### 为什么需要固定配置？
- 确保每次测试使用相同参数
- 避免配置变化导致结果差异
- 便于对比不同阶段的优化效果

---

## 📝 标准测试流程

### 步骤1：准备阶段
```bash
# 1. 备份当前配置
cp Input/Backtest_settings.csv Input/Backtest_settings_backup.csv

# 2. 使用固定测试配置
cp Input/Backtest_settings_regression_test.csv Input/Backtest_settings.csv

# 3. 清理缓存（可选，确保数据一致）
# rm -rf data_cache/*
```

### 步骤2：运行基准测试

**⚠️ 重要说明：**
- **阶段1**: 需要运行优化前的代码作为基准（使用git stash回退）
- **阶段2+**: 直接使用阶段1的基准结果，无需重复运行

#### 阶段1的基准测试流程
```bash
# 1. 回退到优化前的代码
git stash  # 保存当前优化

# 2. 运行基准回测
python3 main.py 2>&1 | tee baseline_backtest.log

# 3. 保存基准结果（重要！）
# 记录关键指标到 baseline_results_phase1.txt
# 这个结果将作为所有后续阶段的基准！
```

#### 阶段2+的基准测试流程
```bash
# 直接使用阶段1保存的基准结果
# baseline_results_phase1.txt 作为对比基准
# 无需重新运行优化前的代码
```

### 步骤3：运行当前阶段优化后测试
```bash
# 1. 如果是阶段1，恢复优化后的代码
git stash pop  # 仅阶段1需要

# 2. 清理缓存冲突（如果有）
git checkout -- data_cache/ logs/

# 3. 运行当前阶段优化后回测
python3 main.py 2>&1 | tee phase{N}_backtest.log

# 4. 保存当前阶段结果
# 记录关键指标到 phase{N}_results.txt
```

### 步骤4：对比结果
```bash
# 使用对比脚本（待创建）
# 所有阶段都与阶段1的基准结果对比
python3 scripts/compare_backtest_results.py \
    --baseline baseline_results_phase1.txt \
    --optimized phase{N}_results.txt \
    --output PHASE{N}_VERIFICATION_REPORT.md
```

### 步骤5：恢复原配置
```bash
# 恢复原始配置
cp Input/Backtest_settings_backup.csv Input/Backtest_settings.csv
```

---

## ✅ 验收标准

### 必须100%一致的指标

| 指标类别 | 指标名称 | 允许误差 |
|---------|---------|---------|
| **收益率** | 总收益率 | 0.00% |
| **收益率** | 年化收益率 | 0.00% |
| **收益率** | 年化波动率 | 0.00% |
| **风险** | 最大回撤 | 0.00% |
| **风险** | 最大回撤持续期 | 0周 |
| **风险** | VaR(95%) | 0.00% |
| **风险** | 年化下行风险 | 0.00% |
| **风险调整** | 夏普比率 | 0.000 |
| **风险调整** | 索提诺比率 | 0.000 |
| **交易** | 总交易次数 | 0 |
| **交易** | 买入次数 | 0 |
| **交易** | 卖出次数 | 0 |
| **交易** | 年化换手率 | 0.00% |
| **信号** | 总信号数 | 0 |
| **信号** | 买入信号数 | 0 |
| **信号** | 卖出信号数 | 0 |

### 验收结果判定

- ✅ **通过**: 所有指标完全一致
- ⚠️ **警告**: 个别指标有微小差异（<0.01%），需要解释原因
- ❌ **失败**: 任何指标差异≥0.01%，必须修复

---

## 📊 报告模板

每个阶段完成后，必须生成验证报告：

### 文件命名
- `PHASE{N}_VERIFICATION_REPORT.md`
- 例如：`PHASE1_VERIFICATION_REPORT.md`

### 报告内容
```markdown
# 阶段{N}回归测试验证报告

## 测试信息
- 测试日期: YYYY-MM-DD
- 测试目的: [本阶段优化内容]
- 测试方法: 使用固定配置对比优化前后结果

## 测试配置
- 配置文件: Input/Backtest_settings_regression_test.csv
- 回测时间段: 2024-01-01 到 2025-01-01
- 回测天数: 357天

## 测试结果对比
[详细对比表格]

## 验证结论
✅/❌ [通过/失败]

## 问题和解决方案
[如果有差异，说明原因和解决方案]
```

---

## 🚨 常见问题

### Q1: 缓存文件导致git冲突怎么办？
```bash
# 清理缓存文件的git状态
git checkout -- data_cache/ logs/
```

### Q2: 结果有微小差异（<0.01%）怎么办？
1. 检查是否是浮点数精度问题
2. 检查随机数种子是否固定
3. 检查数据获取时间戳是否影响结果
4. 如果确认是精度问题，在报告中说明

### Q3: 测试时间太长怎么办？
- 考虑使用更短的测试时间段（如3个月）
- 但必须在所有阶段使用相同的测试配置

### Q4: 如何加快测试速度？
- 保留数据缓存，避免重复下载
- 使用较小的股票池进行快速验证
- 但最终验证必须使用完整配置

---

## 📅 每个阶段的测试要求

| 阶段 | 测试要求 | 预计耗时 |
|-----|---------|---------|
| 阶段1 | ✅ 必须 | 10分钟 |
| 阶段2 | ✅ 必须 | 10分钟 |
| 阶段3 | ✅ 必须 | 10分钟 |
| 阶段4 | ✅ 必须 | 10分钟 |
| 阶段5 | ✅ 必须 | 10分钟 |
| 阶段6 | ✅ 必须 | 10分钟 |
| 阶段7 | ✅ 必须 | 10分钟 |

**总测试时间**: 约70分钟（7个阶段）

---

## 🔄 自动化改进计划

### 短期（立即实施）
- ✅ 创建固定测试配置
- ✅ 建立标准测试流程
- ✅ 制定验收标准

### 中期（阶段2-3实施）
- ⏳ 创建自动对比脚本
- ⏳ 自动生成验证报告
- ⏳ 集成到CI/CD流程

### 长期（阶段4+实施）
- ⏳ 建立完整的测试套件
- ⏳ 自动化回归测试
- ⏳ 性能基准测试

---

## 📌 重要提醒

1. **每个阶段完成后必须运行回归测试**
2. **测试失败必须修复后才能继续下一阶段**
3. **所有测试结果必须记录在案**
4. **测试配置文件禁止修改**

---

**文档版本**: v1.0  
**创建日期**: 2026-01-16  
**维护者**: 项目团队
