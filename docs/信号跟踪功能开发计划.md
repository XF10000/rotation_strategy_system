# 买卖信号跟踪功能开发计划

**版本**: V1.0  
**日期**: 2025-08-28  
**目标**: 实现4维信号分析框架的买卖信号详细跟踪和记录功能

---

## 🎯 项目目标

### 核心需求
- ✅ 只记录BUY/SELL信号，跳过HOLD信号
- ✅ 不记录动态仓位管理信息，专注信号生成模块
- ✅ 记录32个字段的详细4维信号分析信息
- ✅ 输出标准化CSV格式报告
- ✅ 只记录通过4维确认的高质量信号

### 业务价值
- **信号质量分析**: 深入理解4维信号分析框架的实际运行效果
- **策略优化**: 基于历史信号数据优化各维度参数和阈值
- **行业差异研究**: 分析不同申万二级行业的信号特征
- **回测验证**: 提供完整的信号决策依据追溯

---

## 📊 数据记录规范

### 记录字段结构（共32个字段）

#### 1️⃣ 基础信息 (5个字段)
- **date** - 信号生成日期 (YYYY-MM-DD)
- **stock_code** - 股票代码 (如601088)
- **stock_name** - 股票名称 (如中国神华)
- **signal_type** - 信号类型 (BUY/SELL)
- **current_price** - 当前价格 (元)

#### 2️⃣ 4维信号综合决策 (5个字段)
- **dimension_1_status** - 维度一状态 (满足/不满足)
- **tech_dimensions_satisfied** - 技术维度满足数量 (0-3)
- **three_choose_two_result** - "三者取二"结果 (是/否)
- **signal_strength** - 信号强度评分 (0-100)
- **final_decision_basis** - 最终决策依据描述

#### 3️⃣ 维度一：价值准入过滤器 (3个字段)
- **dcf_value** - DCF估值 (元)
- **value_ratio** - 价值比率 (当前价格/DCF估值)
- **value_filter_status** - 价值过滤器状态 (通过/未通过)

#### 4️⃣ 维度二：超买超卖 (9个字段)
- **industry_name** - 申万二级行业名称
- **rsi_14w** - 14周RSI值
- **industry_buy_threshold** - 行业普通买入阈值
- **industry_sell_threshold** - 行业普通卖出阈值
- **industry_extreme_buy** - 行业极端买入阈值
- **industry_extreme_sell** - 行业极端卖出阈值
- **rsi_signal_type** - RSI信号类型 (普通/极端/无)
- **price_divergence** - 价格背离状态 (无/顶背离/底背离)
- **dimension_2_status** - 维度二信号状态 (买入/卖出/无)

#### 5️⃣ 维度三：动能确认 (7个字段)
- **macd_dif** - MACD DIF值
- **macd_dea** - MACD DEA值
- **macd_histogram** - MACD柱体值
- **macd_color** - MACD柱体颜色 (红色/绿色)
- **histogram_trend** - 柱体连续变化 (缩短/放大)
- **golden_cross_status** - 金叉死叉状态 (金叉/死叉/无)
- **dimension_3_status** - 维度三信号状态 (买入/卖出/无)

#### 6️⃣ 维度四：极端放量 (9个字段)
- **bb_middle** - 布林带中轨值
- **bb_upper** - 布林带上轨值
- **bb_lower** - 布林带下轨值
- **price_bb_position** - 价格布林带位置 (突破上轨/跌破下轨/区间内)
- **current_volume** - 当前成交量
- **volume_baseline** - 历史成交量基准
- **volume_ratio** - 成交量放大倍数
- **significant_volume** - 是否显著放量 (是/否)
- **dimension_4_status** - 维度四信号状态 (买入/卖出/无)

#### 7️⃣ 技术指标原始数据 (4个字段)
- **recent_5w_prices** - 最近5周收盘价序列
- **recent_5w_volumes** - 最近5周成交量序列
- **data_quality** - 数据质量状态 (数据长度)
- **calculation_errors** - 计算异常信息

---

## 🏗️ 技术架构设计

### 架构原则
基于项目的**模块化分层架构**和**组件复用开发规范**：

1. **复用现有组件**: 最大化利用signal_generator、backtest_engine、detailed_csv_exporter等现有模块
2. **最小化入侵**: 不破坏现有接口，通过扩展方式实现功能
3. **向后兼容**: 确保新功能不影响现有回测流程
4. **性能优化**: 采用批量处理和内存优化策略

### 核心组件设计

#### SignalTracker 类设计
```python
class SignalTracker:
    """4维买卖信号跟踪器 - 位于backtest模块"""
    
    def __init__(self, output_path: str):
        """初始化信号跟踪器"""
        
    def record_signal(self, signal_data: Dict) -> None:
        """记录单个买卖信号"""
        
    def export_to_csv(self) -> str:
        """导出CSV报告"""
        
    def _format_signal_record(self, signal_data: Dict) -> Dict:
        """格式化信号记录为32字段标准格式"""
        
    def _validate_signal_quality(self, signal_data: Dict) -> bool:
        """验证信号质量（4维确认）"""
```

---

## 📅 开发实施计划

### 阶段一：需求分析与架构设计 (30分钟)

#### 1.1 现有组件分析
- ✅ **signal_generator.py** - 核心信号生成逻辑
- ✅ **detailed_csv_exporter.py** - CSV导出器参考
- ✅ **backtest_engine.py** - 主回测循环集成点

#### 1.2 接口设计确认
- 确定SignalGenerator扩展方式
- 设计BacktestEngine集成点
- 定义数据流转接口

### 阶段二：创建信号跟踪器模块 (60分钟)

#### 2.1 创建核心文件
- **文件**: `backtest/signal_tracker.py`
- **功能**: 实现SignalTracker类的完整功能

#### 2.2 数据结构定义
```python
# 32字段标准化数据结构
SIGNAL_RECORD_FIELDS = [
    # 基础信息 (5个)
    'date', 'stock_code', 'stock_name', 'signal_type', 'current_price',
    
    # 4维综合决策 (5个)
    'dimension_1_status', 'tech_dimensions_satisfied', 'three_choose_two_result',
    'signal_strength', 'final_decision_basis',
    
    # 维度一 (3个)
    'dcf_value', 'value_ratio', 'value_filter_status',
    
    # 维度二 (9个)
    'industry_name', 'rsi_14w', 'industry_buy_threshold', 'industry_sell_threshold',
    'industry_extreme_buy', 'industry_extreme_sell', 'rsi_signal_type', 
    'price_divergence', 'dimension_2_status',
    
    # 维度三 (7个)
    'macd_dif', 'macd_dea', 'macd_histogram', 'macd_color',
    'histogram_trend', 'golden_cross_status', 'dimension_3_status',
    
    # 维度四 (9个)
    'bb_middle', 'bb_upper', 'bb_lower', 'price_bb_position',
    'current_volume', 'volume_baseline', 'volume_ratio',
    'significant_volume', 'dimension_4_status',
    
    # 原始数据 (4个)
    'recent_5w_prices', 'recent_5w_volumes', 'data_quality', 'calculation_errors'
]
```

#### 2.3 核心功能实现
- 信号记录缓存机制
- CSV格式化输出
- 数据质量验证
- 异常处理机制

### 阶段三：增强信号生成器 (90分钟)

#### 3.1 扩展SignalGenerator输出
**文件**: `strategy/signal_generator.py`

**修改要点**:
```python
def generate_signal(self, stock_code: str, data: pd.DataFrame) -> Dict:
    """扩展现有方法，增加详细信号信息输出"""
    
    # 新增：收集详细的4维信息
    if signal_result['signal'] in ['BUY', 'SELL']:
        detailed_signal_info = self._collect_detailed_signal_info(
            stock_code, data, indicators, scores, signal_result
        )
        signal_result['detailed_info'] = detailed_signal_info
    
    return signal_result

def _collect_detailed_signal_info(self, stock_code, data, indicators, scores, signal_result):
    """收集32个字段的详细信号信息"""
    # 实现详细信息收集逻辑
    # 维度一：价值准入过滤器信息
    # 维度二：超买超卖详细信息
    # 维度三：MACD动能确认信息
    # 维度四：极端放量信息
    # 技术指标原始数据
```

#### 3.2 保持向后兼容性
- 不修改现有signal_result核心结构
- 通过新增'detailed_info'字段提供扩展
- 确保现有调用方不受影响

### 阶段四：集成到回测引擎 (60分钟)

#### 4.1 修改BacktestEngine
**文件**: `backtest/backtest_engine.py`

**关键修改点**:
```python
class BacktestEngine:
    def __init__(self, config):
        # 新增：初始化信号跟踪器
        self.signal_tracker = SignalTracker('output/signal_tracking_report.csv')
    
    def _generate_signals(self, current_date):
        """在现有信号生成中集成跟踪功能"""
        signals = {}
        
        for stock_code in self.stock_pool:
            signal_result = self.signal_generator.generate_signal(stock_code, stock_data)
            signals[stock_code] = signal_result
            
            # 新增：记录BUY/SELL信号
            if signal_result['signal'] in ['BUY', 'SELL']:
                self.signal_tracker.record_signal({
                    'date': current_date,
                    'stock_code': stock_code,
                    'signal_result': signal_result
                })
        
        return signals
```

#### 4.2 报告导出集成
```python
def run_backtest(self):
    # ... existing backtest logic ...
    
    # 新增：导出信号跟踪报告
    signal_report_path = self.signal_tracker.export_to_csv()
    self.logger.info(f"📊 信号跟踪报告已生成: {signal_report_path}")
    
    return {
        # ... existing results ...
        'signal_tracking_report': signal_report_path
    }
```

### 阶段五：数据验证与测试 (45分钟)

#### 5.1 功能测试
- **信号过滤测试**: 验证只记录BUY/SELL信号
- **数据完整性测试**: 检查32个字段数据完整性
- **4维确认测试**: 确认只记录高质量信号

#### 5.2 集成测试
- **完整回测测试**: 运行main.py验证功能集成
- **CSV输出验证**: 检查输出格式和内容正确性
- **性能影响评估**: 测试对回测性能的影响

#### 5.3 边界条件测试
- 数据不足情况处理
- 计算异常情况处理
- 文件写入权限测试

### 阶段六：文档与优化 (30分钟)

#### 6.1 使用文档
```markdown
# 信号跟踪功能使用指南

## 基本使用
正常运行回测即可自动生成信号跟踪报告：
```bash
python main.py
```

## 输出文件
- **位置**: `output/signal_tracking_report.csv`
- **格式**: CSV格式，32列详细信号数据
- **编码**: UTF-8

## 字段说明
[详细字段说明...]
```

#### 6.2 性能优化策略
- **批量写入**: 避免频繁磁盘IO
- **内存管理**: 大数据集分批处理
- **缓存优化**: 技术指标计算结果复用

---

## 📊 预期交付物

### 核心代码文件
1. **backtest/signal_tracker.py** - 信号跟踪器核心模块
2. **增强的strategy/signal_generator.py** - 扩展详细信息输出
3. **集成的backtest/backtest_engine.py** - 主回测引擎集成

### 输出文件
4. **output/signal_tracking_report.csv** - 详细信号跟踪报告
5. **docs/信号跟踪功能使用指南.md** - 使用文档

### 验证报告
6. **测试验证结果** - 功能测试和性能评估报告

---

## ⏱️ 时间估算

| 阶段 | 预估时间 | 主要交付物 |
|------|----------|-----------|
| 阶段一 | 30分钟 | 架构设计文档 |
| 阶段二 | 60分钟 | SignalTracker类实现 |
| 阶段三 | 90分钟 | SignalGenerator增强 |
| 阶段四 | 60分钟 | BacktestEngine集成 |
| 阶段五 | 45分钟 | 测试验证报告 |
| 阶段六 | 30分钟 | 文档和优化 |
| **总计** | **5.25小时** | **完整功能实现** |

---

## 🎯 成功标准

### 功能性标准
- ✅ 只记录BUY/SELL信号，无HOLD信号
- ✅ 32个字段数据完整准确
- ✅ 只记录通过4维确认的高质量信号
- ✅ CSV格式标准化，便于后续分析

### 技术性标准
- ✅ 代码复用率 > 80%
- ✅ 性能影响 < 10%
- ✅ 向后兼容，不破坏现有功能
- ✅ 代码规范，易于维护

### 业务价值标准
- ✅ 提供完整的信号决策追溯
- ✅ 支持策略优化和参数调整
- ✅ 便于行业差异分析
- ✅ 增强回测结果可信度

---

**文档维护**: 本开发计划将随着实施进度持续更新，确保开发过程可追溯、可管理。

**项目负责人**: AI助手  
**最后更新**: 2025-08-28