# 中线轮动策略回测系统技术说明文档 v2.0

## 系统概述

本系统是一个完整的股票轮动策略回测平台，支持4维信号分析、技术指标计算、交易成本模拟和详细的报告生成。

## 核心功能

### 1. 数据处理模块 (`data/`)
- **数据获取** (`data_fetcher.py`): 基于Akshare的股票数据获取
- **数据处理** (`data_processor.py`): 日线转周线、技术指标计算
- **数据存储** (`data_storage.py`): 本地数据缓存和管理

### 2. 策略模块 (`strategy/`)
- **信号生成** (`signal_generator.py`): 4维信号分析算法
- **投资组合管理** (`portfolio_manager.py`): 持仓管理和资金分配

### 3. 回测引擎 (`backtest/`)
- **回测核心** (`backtest_engine.py`): 主要回测逻辑
- **交易成本** (`transaction_cost.py`): 手续费、印花税、滑点计算
- **CSV导出** (`detailed_csv_exporter.py`): 详细交易记录导出
- **报告生成** (`enhanced_report_generator_integrated_fixed.py`): HTML报告生成

## 新增功能特性

### 📊 详细CSV导出功能
系统现在支持导出包含28列详细信息的CSV文件：

#### CSV文件列结构
```
1. 日期 - 交易日期
2. 交易类型 - BUY/SELL
3. 股票代码 - 6位股票代码
4. 交易股票数量 - 实际交易股数
5. 交易后持仓数量 - 交易完成后的持仓
6. 收盘价 - 当日收盘价
7. 20周EMA - 20周指数移动平均
8. 趋势过滤器状态 - ✓/✗
9. 14周RSI - 相对强弱指数
10. RSI信号状态 - ✓/✗
11. MACD_DIF - MACD差离值
12. MACD_DEA - MACD信号线
13. MACD信号状态 - ✓/✗
14. 布林带位置 - 上轨之上/轨道之间/下轨之下
15. 量能倍数 - 当周成交量/4周均量
16. 布林带+量能状态 - ✓/✗
17. 4维信号综合分析 - 满足维度数/总维度数 + 信号原因
18. 交易价格 - 实际成交价格
19. 交易金额 - 交易总金额
20. 手续费 - 交易手续费
21. 印花税 - 印花税费用
22. 滑点成本 - 滑点损失
23. 总交易成本 - 所有费用合计
24. 交易后现金 - 交易完成后现金余额
25. 交易后总资产 - 交易完成后总资产
26. 累计收益率 - 从开始到当前的累计收益率
27. 信号置信度 - 信号强度评分(0-100)
28. 备注 - 额外说明信息
```

### 🎯 真实基准对比功能
- **动态基准计算**: 基于实际股票池的买入持有策略表现
- **等权重基准**: 假设在回测开始时等权重买入所有股票并持有到结束
- **真实超额收益**: 策略收益率 - 基准收益率的真实差值

### 📈 增强版HTML报告
- **K线图交易点**: 可视化买卖点标记，支持多股票切换
- **4维信号详情表**: 完整的技术指标和信号状态分析
- **基准对比分析**: 策略vs买入持有的详细对比
- **交易统计**: 交易次数、手续费、胜率等统计指标

## 输出文件

系统会在 `reports/` 目录下生成以下文件：

### 1. HTML报告 (`integrated_backtest_report_*.html`)
- **完整的可视化回测报告**
- **K线图与交易点分析**: 支持股票切换的交互式K线图
- **基础回测指标**: 收益率、年化收益率、最大回撤等
- **策略vs基准对比**: 真实的基准对比分析
- **最终持仓状态**: 回测结束时的详细持仓情况
- **交易统计指标**: 交易次数、手续费统计
- **详细交易记录**: 包含4维信号状态的完整交易表格
- **信号统计分析**: 各股票的信号触发统计

### 2. 详细交易记录CSV (`detailed_trading_records_*.csv`)
- **28列完整交易数据**: 包含所有技术指标和交易细节
- **4维信号分析**: 每笔交易的信号状态详情
- **交易成本明细**: 手续费、印花税、滑点等详细成本
- **资产变化跟踪**: 每笔交易后的资产状况
- **Excel兼容**: 支持UTF-8-BOM编码，Excel可直接打开

## 技术指标计算

### 4维信号分析框架
1. **趋势过滤器（硬性条件）**
   - 买入: 收盘价 < 20周EMA 且 EMA向下
   - 卖出: 收盘价 > 20周EMA 且 EMA向上

2. **超买/超卖信号**
   - RSI14 > 70 (超买) / RSI14 < 30 (超卖)
   - 支持顶背离/底背离检测

3. **动能确认信号**
   - MACD柱体连续缩短
   - MACD DIF线金叉/死叉DEA线

4. **极端价格+量能信号**
   - 布林带位置判断
   - 成交量相对4周均量的倍数

### 交易成本模拟
- **买入手续费**: 0.03%
- **卖出手续费**: 0.03%
- **印花税**: 0.1% (仅卖出)
- **滑点**: 0.1%

## 配置管理

### 回测配置 (`config/backtest_configs.py`)
支持多种预设配置：
- `standard`: 标准配置
- `conservative`: 保守配置
- `aggressive`: 激进配置
- `short_test`: 短期测试配置
- `no_industry_optimization`: 无行业优化配置

### 股票池配置 (`config/stock_pools.py`)
- 支持多个股票池配置
- DCF估值集成
- 行业分类管理

## 使用方法

### 基本运行
```bash
python main.py
```

### 指定配置运行
```bash
python main.py --config conservative
```

### 输出文件位置
- HTML报告: `reports/integrated_backtest_report_YYYYMMDD_HHMMSS.html`
- CSV文件: `reports/detailed_trading_records_YYYYMMDD_HHMMSS.csv`

## 系统要求

### Python依赖
```
pandas >= 1.3.0
numpy >= 1.21.0
akshare >= 1.8.0
pandas-ta >= 0.3.14b
matplotlib >= 3.5.0
plotly >= 5.0.0
```

### 系统要求
- Python 3.8+
- 内存: 建议4GB+
- 存储: 建议1GB+可用空间

## 性能优化

### 数据缓存
- 本地数据缓存机制
- 避免重复网络请求
- 支持增量数据更新

### 计算优化
- 向量化技术指标计算
- 批量数据处理
- 内存使用优化

## 错误处理

### 数据获取错误
- 网络连接失败自动重试
- 数据缺失警告提示
- 备用数据源支持

### 计算错误
- 技术指标计算异常处理
- 交易信号验证
- 资产计算一致性检查

## 扩展性

### 新增技术指标
在 `data/data_processor.py` 中添加新的技术指标计算方法

### 新增信号维度
在 `strategy/signal_generator.py` 中扩展信号生成逻辑

### 自定义报告
在 `backtest/enhanced_report_generator_integrated_fixed.py` 中自定义报告模板

## 版本历史

### v2.0 (当前版本)
- ✅ 新增28列详细CSV导出功能
- ✅ 真实基准对比计算
- ✅ 增强版HTML报告
- ✅ K线图交易点可视化
- ✅ 4维信号详情分析
- ✅ 交易成本详细计算

### v1.0
- 基础回测功能
- 简单HTML报告
- 基本技术指标计算

## 联系与支持

如有问题或建议，请查看项目文档或提交Issue。

---
*最后更新: 2025-07-27*