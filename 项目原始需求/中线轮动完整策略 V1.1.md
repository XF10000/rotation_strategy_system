来源：[[中线仓位兑换（10%）完整策略 V1.0]]

────────────────────────  
中线仓位兑换（10%）完整策略 V1.1
只服务「已研究透」的价值股票池，周线级别，先卖后买或现金直买均可。  
────────────────────────  

一、使用范围  
1. 股票：你已用 DCF 估值并留有安全边际的持仓（例：煤炭、电解铝、锂矿、麻醉药、预制菜）。  
2. 周期：周线（收盘后跑脚本，次周开盘执行）。  
3. 单次：固定 10% 仓位；无配对时转现金或现金直买。  

二、信号规则（共 4 维，硬性前提 + 3 选 2）  

| 维度             | 阶段高点（卖出 10%）                 | 阶段低点（买入 10%）                 |
| :------------- | :--------------------------- | :--------------------------- |
| **价值比过滤器（硬性）** | 收盘价 > DCF 每股估值的 80%          | 收盘价 < DCF 每股估值的 70%          |
| **超买/超卖**      | 14 周 RSI > 70 且出现顶背离         | 14 周 RSI < 30 且出现底背离         |
| **动能确认**       | MACD 红色柱体连续 2 根缩短 或 MACD 柱体已为绿色 或 DIF 死叉 DEA | MACD 绿色柱体连续 2 根缩短 或 MACD 柱体已为红色 或 DIF 金叉 DEA |
| **极端价格 + 量能**  | 收盘价 ≥ 布林上轨 且本周量 ≥ 4 周均量 ×1.3 | 收盘价 ≤ 布林下轨 且本周量 ≥ 4 周均量 ×0.8 |

触发逻辑：

- 先满足「价值比过滤器」→ 再在其余 3 条里**至少满足 2 条** → 生成信号。  



三、背离的量化定义  
```python
def rsi_divergence(df, direction='top'):
    price = df['close']
    rsi   = df['rsi14']
    n = 13   # 回溯 13 周
    if direction == 'top':
        return price.iloc[-1] == price.rolling(n).max().iloc[-1] and \
               rsi.iloc[-1]  < rsi.rolling(n).max().iloc[-1]
    else:  # bottom
        return price.iloc[-1] == price.rolling(n).min().iloc[-1] and \
               rsi.iloc[-1]  > rsi.rolling(n).min().iloc[-1]
```

四、执行流程（每周一次）  
1. 收盘后脚本跑完 5 只股票 → 输出 `score_sell` / `score_buy`（0-3 分）。  
2. 排序：  
   • 若 A `score_sell≥2` 且 B `score_buy≥2`，提示「A→B 兑换 10%」。  
   • 仅有卖出或买入信号 → 转现金或现金直买。  
3. 次周开盘机械执行；不做盘中追价。  

五、人工再确认（5 秒原则）  
- 触发卖出：当前市值 ≥ 你最新 DCF 估值 90% → 正常卖出；否则减仓 5% 或跳过。  
- 触发买入：当前市值 ≤ 你最新 DCF 估值 70% → 正常买入；否则减额或跳过。  
- 重大基本面变化 → 无视技术信号直接处理。  

六、Python 模板（可直接跑）  
```python
import akshare as ak, pandas as pd, pandas_ta as ta, datetime as dt

codes = {'煤炭':'601088', '电解铝':'000807', '锂矿':'002460',
         '麻醉药':'002262', '预制菜':'002330'}
swap_pct = 0.10

def get_weekly(code, start='20200101'):
    df = ak.stock_zh_a_hist(symbol=code, period="weekly", start_date=start, adjust="")
    df['date'] = pd.to_datetime(df['日期'])
    return df.set_index('date')[['收盘','成交量']].rename(columns={'收盘':'close'})

def signal(df):
    df['ema20'] = ta.ema(df['close'], 20)
    df['ema_up'] = df['ema20'] > df['ema20'].shift(1)
    df['rsi14'] = ta.rsi(df['close'], 14)
    macd = ta.macd(df['close']); df['hist'] = macd['MACDh_12_26_9']
    bb = ta.bbands(df['close'], 20, 2); df['ub'], df['lb'] = bb['BBU_20_2.0'], bb['BBL_20_2.0']
    vol_ok = df['成交量'] / df['成交量'].rolling(4).mean()

    # 背离
    price, rsi = df['close'], df['rsi14']
    top_div   = (price==price.rolling(13).max()) & (rsi<rsi.rolling(13).max())
    bot_div   = (price==price.rolling(13).min()) & (rsi>rsi.rolling(13).min())

    latest = df.iloc[-1]; prev_hist = df['hist'].iloc[-3:-1]

    cond_high = [
        latest['close'] > latest['ema20'] and latest['ema_up'],   # 趋势
        latest['rsi14'] > 70 and top_div.iloc[-1],                # RSI
        (latest['hist'] < prev_hist.iloc[-1] and latest['hist'] < prev_hist.iloc[-2]) or (macd['MACD_12_26_9'].iloc[-1] < macd['MACDs_12_26_9'].iloc[-1]),  # MACD
        latest['close'] >= latest['ub'] and vol_ok.iloc[-1] >= 1.3  # 布林+量
    ]

    cond_low = [
        latest['close'] < latest['ema20'] and not latest['ema_up'],
        latest['rsi14'] < 30 and bot_div.iloc[-1],
        (latest['hist'] > prev_hist.iloc[-1] and latest['hist'] > prev_hist.iloc[-2]) or (macd['MACD_12_26_9'].iloc[-1] > macd['MACDs_12_26_9'].iloc[-1]),
        latest['close'] <= latest['lb'] and vol_ok.iloc[-1] >= 0.8
    ]

    trend_ok_high = cond_high[0]
    trend_ok_low  = cond_low[0]
    score_sell = trend_ok_high and sum(cond_high[1:]) >= 2
    score_buy  = trend_ok_low  and sum(cond_low[1:])  >= 2
    return {'sell': score_sell, 'buy': score_buy}

# 运行
signals = {name: signal(get_weekly(code)) for name, code in codes.items()}
sell_list = [n for n,s in signals.items() if s['sell']]
buy_list  = [n for n,s in signals.items() if s['buy']]
print('本周信号:', signals)
if sell_list and buy_list:
    print('建议兑换：卖出', sell_list, '→ 买入', buy_list, '各', f'{swap_pct*100:.0f}%')
elif sell_list:
    print('建议：卖出', sell_list, f'各 {swap_pct*100:.0f}% → 现金')
elif buy_list:
    print('建议：现金买入', buy_list, f'各 {swap_pct*100:.0f}%')
else:
    print('本周无信号')
```

七、风控与复盘  
- 单次最大 10% 仓位；  
- 每月底人工回顾：统计胜率、盈亏比，必要时微调 RSI 阈值或量能倍数；  
- 任何基本面突变（政策、产能、管理层）优先于技术信号。

────────────────────────  
把脚本设成定时任务（Windows 任务计划 / Linux crontab），每周日收盘后跑一次即可。


#股票 #技术分析 