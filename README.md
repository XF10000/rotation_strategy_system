# 中线轮动策略回测系统 v2.0

一个专业的股票轮动策略回测平台，支持4维信号分析、详细交易记录导出和可视化报告生成。

## 🚀 核心特性

### 🚀 性能优化
- **季度自动更新**: 行业映射文件和RSI阈值文件每季度自动更新，确保数据时效性
- **本地缓存机制**: 5,209只股票的申万二级行业映射本地缓存，避免网络查询
- **动态RSI阈值**: 124个申万二级行业的个性化RSI超买超卖阈值
- **快速启动**: 从原来的数分钟网络查询优化到秒级启动

### 📊 详细CSV导出
- **28列完整交易数据**: 包含技术指标、信号状态、交易成本等详细信息
- **4维信号分析**: 趋势过滤器、超买超卖、动能确认、极端价格+量能
- **Excel兼容**: UTF-8-BOM编码，Excel可直接打开

### 🎯 真实基准对比
- **动态基准计算**: 基于实际股票池的买入持有策略表现
- **等权重基准**: 真实反映股票池整体表现
- **准确超额收益**: 策略收益率 - 基准收益率的真实差值

### 📈 增强版可视化报告
- **交互式K线图**: 支持多股票切换，买卖点清晰标记
- **4维信号详情表**: 完整的技术指标和信号状态分析
- **基准对比分析**: 策略vs买入持有的详细对比
- **交易统计**: 交易次数、手续费、胜率等统计指标

## 📁 项目结构

```
├── main.py                 # 主程序入口
├── config/                 # 配置文件
│   ├── stock_pools.py     # 股票池配置
│   └── backtest_configs.py # 回测配置
├── data/                   # 数据处理模块
│   ├── data_fetcher.py    # 数据获取
│   ├── data_processor.py  # 数据处理
│   └── data_storage.py    # 数据存储
├── strategy/               # 策略模块
│   ├── signal_generator.py # 信号生成
│   └── portfolio_manager.py # 投资组合管理
├── backtest/               # 回测引擎
│   ├── backtest_engine.py # 回测核心
│   ├── transaction_cost.py # 交易成本
│   ├── detailed_csv_exporter.py # CSV导出
│   └── enhanced_report_generator_integrated_fixed.py # 报告生成
├── utils/                  # 工具模块
│   ├── industry_classifier.py # 行业分类器
│   ├── industry_mapper.py     # 行业映射生成器
│   ├── industry_mapping_updater.py # 行业映射季度自动更新器
│   ├── rsi_threshold_updater.py # RSI阈值季度自动更新器
│   └── stock_to_industry_map.json # 行业映射缓存文件
├── sw_rsi_thresholds/          # RSI阈值计算模块
│   ├── sw_industry_rsi_thresholds.py # RSI阈值计算核心
│   ├── run_sw_2021_rsi_calculation.py # RSI阈值计算脚本
│   └── output/
│       └── sw2_rsi_threshold.csv # 动态RSI阈值文件
└── reports/                # 输出报告目录
```

## 🛠️ 安装与使用

### 环境要求
- **Python版本**: 3.8 或更高版本（推荐 3.9+）
- **内存**: 建议4GB+
- **存储**: 建议1GB+可用空间
- **网络**: 需要访问股票数据API

### 快速安装
```bash
# 1. 安装所有依赖包
pip install -r requirements.txt

# 2. 如果网络较慢，使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 详细安装说明
请参考 [INSTALL.md](INSTALL.md) 获取完整的安装指南，包括：
- 虚拟环境创建
- TA-Lib特殊安装说明
- 常见问题解决方案
- 依赖包详细说明

### 基本使用
```bash
# 运行回测（使用CSV配置文件）
python main.py

# 手动更新行业映射文件
python utils/industry_mapper.py --force

# 检查行业映射文件状态
python utils/industry_mapping_updater.py --status

# 手动更新RSI阈值文件
python utils/rsi_threshold_updater.py --force

# 检查RSI阈值文件状态
python utils/rsi_threshold_updater.py --status
```

## 📊 输出文件

### 1. HTML可视化报告
**文件**: `reports/integrated_backtest_report_YYYYMMDD_HHMMSS.html`

**内容包含**:
- 📈 交互式K线图与交易点分析
- 📊 基础回测指标 (收益率、年化收益率、最大回撤)
- 🎯 策略vs基准详细对比
- 💼 最终持仓状态
- 📋 详细交易记录 (4维信号状态分析)
- 📊 信号统计分析

### 2. 详细交易记录CSV
**文件**: `reports/detailed_trading_records_YYYYMMDD_HHMMSS.csv`

**28列数据包含**:
```
日期, 交易类型, 股票代码, 交易股票数量, 交易后持仓数量,
收盘价, 20周EMA, 趋势过滤器状态, 14周RSI, RSI信号状态,
MACD_DIF, MACD_DEA, MACD信号状态, 布林带位置, 量能倍数,
布林带+量能状态, 4维信号综合分析, 交易价格, 交易金额,
手续费, 印花税, 滑点成本, 总交易成本, 交易后现金,
交易后总资产, 累计收益率, 信号置信度, 备注
```

## 🎯 4维信号分析框架

### 1. 趋势过滤器 (硬性条件)
- **买入**: 收盘价 < 20周EMA 且 EMA向下
- **卖出**: 收盘价 > 20周EMA 且 EMA向上

### 2. 超买/超卖信号（动态RSI阈值）
- **个性化阈值**: 每个申万二级行业使用专属的RSI超买超卖阈值
- **波动率分层**: 根据行业历史波动率分为低/中/高波动三层
- **动态计算**: 基于104周历史数据和RSI分布统计确定阈值
- **示例阈值**: 煤炭开采(超卖≤34.31, 超买≥69.30), 银行(超卖≤49.75, 超买≥73.46)

### 3. 动能确认信号
- **卖出条件**: MACD红色柱体连续2根缩短 或 MACD柱体已为绿色 或 DIF死叉DEA
- **买入条件**: MACD绿色柱体连续2根缩短 或 MACD柱体已为红色 或 DIF金叉DEA

### 4. 极端价格+量能信号
- **买入**: 收盘价 ≤ 布林下轨 且 成交量 ≥ 4周均量×0.8
- **卖出**: 收盘价 ≥ 布林上轨 且 成交量 ≥ 4周均量×1.3

**触发条件**: 趋势过滤器(必须) + 其他3维中至少2维满足

## 💰 渐进式买卖逻辑 V3.0 (2025-08-05更新)

### 🎯 核心理念
采用渐进式买卖策略，每次交易固定20%比例，避免一次性大额交易，提高风险控制能力。

### 📈 买入信号执行
- **无持仓时**: 买入现金的20%
- **有持仓时**: 买入当前持仓市值的20%（加仓）
- **最小单位**: 100股整数倍（符合A股规则）

### 📉 卖出信号执行
- **无持仓时**: 忽略卖出信号
- **有持仓时**: 卖出当前持仓市值的20%（减仓）
- **边界保护**: 不超过当前持仓数量

### 💡 实际案例
```
云铝股份买入信号（有持仓）:
- 当前持仓: 10,000股 × 6.69元 = 66,900元
- 买入金额: 66,900 × 20% = 13,380元
- 买入股数: 1,900股（100股整数倍）
- 实际成本: 12,711元

中国神华买入信号（无持仓）:
- 当前现金: 500,000元
- 买入金额: 500,000 × 20% = 100,000元
- 买入股数: 13,800股
- 实际成本: 99,498元
```

### 🛡️ 边界保护
- **最小交易**: 少于100股时不执行
- **现金检查**: 确保资金充足
- **持仓检查**: 卖出不超过实际持仓

## 💸 交易成本模拟

- **买入手续费**: 0.03%
- **卖出手续费**: 0.03%
- **印花税**: 0.1% (仅卖出)
- **滑点**: 0.1%

## ⚙️ 配置选项

### CSV配置文件
系统现在使用CSV配置文件进行设置，更加灵活和直观：

#### 1. 投资组合配置 (`Input/portfolio_config.csv`)
```csv
Stock_number,Stock_name,Initial_weight,Industry,DCF_value_per_share
601088,中国神华,0.0615,煤炭开采,40
600900,长江电力,0.0577,电力,35
CASH,现金,0.0093,,
```

#### 2. 回测设置 (`Input/Becktest_settings.csv`)
```csv
Parameter,Value
total_capital,15000000
start_date,2021-01-08
end_date,2025-07-25
```

#### 3. 行业RSI阈值 (`Input/industry_rsi_thresholds.csv`)
```csv
Industry,RSI_Overbought,RSI_Oversold,Divergence_Required,Strategy_Type
煤炭开采,75,25,是,保守型
电力,75,35,否,极度保守型
```

## 📈 示例结果

### 回测表现对比
| 指标 | 轮动策略 | 买入持有基准 | 超额收益 |
|------|----------|-------------|----------|
| 总收益率 | 67.71% | 106.18% | -38.47% |
| 年化收益率 | 15.70% | 22.52% | -6.82% |
| 最大回撤 | -13.83% | -84.94% | +71.11% |
| 最终资金 | ¥1,673,393 | ¥2,061,800 | -¥388,407 |

### 交易统计
- 总交易次数: 7次
- 买入次数: 4次
- 卖出次数: 3次
- 总手续费: ¥748.20
- 手续费率: 0.0748%

## 🔧 系统维护

### 行业映射文件管理
系统使用申万二级行业分类，包含124个行业、5,209只股票的映射关系：

```bash
# 查看映射文件状态
python utils/industry_mapping_updater.py --status

# 强制更新映射文件
python utils/industry_mapping_updater.py --force

# 手动生成映射文件
python utils/industry_mapper.py --force
```

### RSI动态阈值文件管理
系统使用申万二级行业个性化RSI阈值，包含124个行业的动态超买超卖阈值：

```bash
# 查看RSI阈值文件状态
python utils/rsi_threshold_updater.py --status

# 强制更新RSI阈值文件
python utils/rsi_threshold_updater.py --force

# 手动生成RSI阈值文件
python sw_rsi_thresholds/run_sw_2021_rsi_calculation.py
```

**RSI阈值特性**：
- 📊 **124个申万二级行业**：每个行业独立的RSI阈值
- 📈 **波动率分层**：低/中/高波动三层，不同层级不同阈值策略
- 🔄 **104周历史数据**：基于2年历史数据统计计算
- 🎯 **个性化阈值**：替代传统30/70固定阈值，提高信号准确性

**自动更新机制**：
- ✅ **季度自动检查**：每个季度第一次运行时自动检查更新
- ✅ **跨年度更新**：跨年时强制更新
- ✅ **过期检查**：文件超过4个月自动更新
- ✅ **异常检测**：行业数量异常时重新生成

### 扩展开发

#### 新增技术指标
在 `data/data_processor.py` 中添加:
```python
def calculate_custom_indicator(self, data):
    # 自定义指标计算逻辑
    return indicator_values
```

#### 新增信号维度
在 `strategy/signal_generator.py` 中扩展:
```python
def generate_custom_signal(self, data):
    # 自定义信号生成逻辑
    return signal_result
```

## 📚 文档

- [策略说明文档](中线轮动完整策略%20v1.0.md) - 完整的策略规则说明
- [技术说明文档](回测系统技术说明文档.md) - 详细的技术实现说明
- [集成报告使用说明](集成报告使用说明.md) - HTML报告使用指南

## 🐛 问题反馈

如遇到问题或有改进建议，请提交Issue或查看项目文档。

## 📄 许可证

本项目仅供学习和研究使用，不构成投资建议。

## 📝 版本更新记录

### V3.1 (2025-08-22)
- ✅ **季度自动更新**: 行业映射文件和RSI阈值文件每季度自动更新机制
- ✅ **性能大幅提升**: 本地缓存5,209只股票行业映射，避免网络查询
- ✅ **动态RSI阈值**: 124个申万二级行业个性化RSI超买超卖阈值
- ✅ **启动速度优化**: 从数分钟网络查询优化到秒级启动
- ✅ **智能更新策略**: 跨季度、跨年度、文件过期自动检测更新
- ✅ **申万二级行业**: 完整的124个申万二级行业分类支持

### V3.0 (2025-08-05)
- ✅ **渐进式买卖逻辑**: 新增20%固定比例的渐进式买卖策略
- ✅ **投资组合初始化优化**: 修复价格数据匹配问题，确保计算准确性
- ✅ **边界条件完善**: 100股整数倍约束、现金不足保护、持仓检查
- ✅ **风险控制提升**: 避免一次性大额交易，降低市场冲击
- ✅ **资金效率优化**: 智能基准选择，提高资金使用效率

### V2.0 (2025-07-27)
- ✅ **详细CSV导出**: 28列完整交易数据
- ✅ **4维信号分析**: 完整的技术指标和信号状态
- ✅ **增强版可视化**: 交互式K线图和详细报告
- ✅ **真实基准对比**: 动态基准计算和超额收益分析

### V1.0 (历史版本)
- 基础回测功能
- 简单信号生成
- 基本报告输出

## 📚 相关文档

- [渐进式买卖逻辑设计文档](渐进式买卖逻辑设计文档.md) - 详细的买卖逻辑说明
- [策略说明文档](项目原始需求/中线轮动完整策略_行业优化版_v2.0.md) - 完整的策略规则
- [增强版回测系统功能总结](增强版回测系统功能总结.md) - 系统功能详细说明
- [安装指南](INSTALL.md) - 详细的安装说明

---

**⚠️ 风险提示**: 本系统仅用于策略回测和研究，实际投资请谨慎决策，投资有风险。

*最后更新: 2025-08-22*
